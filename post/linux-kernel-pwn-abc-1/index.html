<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linux Kernel Pwn ABC(Ⅰ)(draft) - localhost - Done with development, it&#39;s time to pwn.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="M4x" />
  <meta name="description" content="
" />
<meta name="keywords" content="kernel" />







<meta name="generator" content="Hugo 0.48" />


<link rel="canonical" href="https://bash-c.github.io/post/linux-kernel-pwn-abc-1/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="Linux Kernel Pwn ABC(Ⅰ)(draft)" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bash-c.github.io/post/linux-kernel-pwn-abc-1/" /><meta property="article:published_time" content="2018-10-03T19:50:41&#43;08:00"/>
<meta property="article:modified_time" content="2018-10-03T19:50:41&#43;08:00"/>
<meta itemprop="name" content="Linux Kernel Pwn ABC(Ⅰ)(draft)">
<meta itemprop="description" content="">


<meta itemprop="datePublished" content="2018-10-03T19:50:41&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-03T19:50:41&#43;08:00" />
<meta itemprop="wordCount" content="2569">



<meta itemprop="keywords" content="kernel,pwn," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux Kernel Pwn ABC(Ⅰ)(draft)"/>
<meta name="twitter:description" content=""/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"># </a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      # 
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Linux Kernel Pwn ABC(Ⅰ)(draft)</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2018-10-03 </span>
        <div class="post-category">
            <a href="https://bash-c.github.io/categories/how2/"> how2 </a>
            
          </div>
        <span class="more-meta"> 2569 words </span>
          <span class="more-meta"> 6 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#basic-knowledge">Basic Knowledge</a>
<ul>
<li><a href="#kernel">Kernel</a></li>
<li><a href="#ring-model">Ring Model</a></li>
<li><a href="#loadable-kernel-modules-lkms">Loadable Kernel Modules(LKMs)</a>
<ul>
<li><a href="#常用指令">常用指令</a></li>
</ul></li>
<li><a href="#syscall">syscall</a></li>
<li><a href="#状态切换">状态切换</a>
<ul>
<li><a href="#user-space-to-kernel-space">user space to kernel space</a></li>
<li><a href="#kernel-space-to-user-space">kernel space to user space</a></li>
</ul></li>
<li><a href="#mitigation">Mitigation</a></li>
<li><a href="#ctf-kernel-pwn-相关">CTF kernel pwn 相关</a></li>
</ul></li>
<li><a href="#example">Example</a>
<ul>
<li><a href="#kernel-uaf">kernel UAF</a></li>
</ul></li>
<li><a href="#reference-and-thanks-to">Reference and Thanks to</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p></p>

<p>记录一下最近学到的 linux kernel pwn 知识，比较基础。</p>

<h2 id="basic-knowledge">Basic Knowledge</h2>

<p>主要参考了 <a href="https://github.com/bash-c/slides/blob/master/pwn_kernel/13_lecture.pdf">Linux Kernel Exploitation</a>。</p>

<h3 id="kernel">Kernel</h3>

<p>kernel 也是一个程序，用来管理软件发出的数据 I/O 要求，讲这些要求转义为指令，交给 CPU 和计算机中的其他组件处理，是现代操作系统最基本的部分。</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/8/8f/Kernel_Layout.svg" alt="" /></p>

<p>kernel 最主要的功能有两点：</p>

<ol>
<li>控制并与硬件进行交互</li>
<li>提供 application 能运行的环境</li>
</ol>

<p>包括 I/O，权限控制，系统调用，进程管理，内存管理等多项功能都可以归结到上边两点中。</p>

<p>需要注意的是，<strong>kernel 的 crash 通常会引起重启</strong>。</p>

<h3 id="ring-model">Ring Model</h3>

<p>intel CPU 将 CPU 的特权级别分为 4 个级别：Ring 0, Ring 1, Ring 2, Ring 3。</p>

<p>Ring0 只给 OS 使用，Ring 3 所有程序都可以使用，内层 Ring 可以随便使用外层 Ring 的资源。</p>

<p>使用 Ring Model 是为了提升系统安全性，例如某个间谍软件作为一个在 Ring 3 运行的用户程序，在不通知用户的时候打开摄像头会被阻止，因为访问硬件需要使用being驱动程序保留的 Ring 1 的方法。</p>

<p>大多数的现代操作系统只使用了 Ring 0 和 Ring 3。
<img src="http://ww1.sinaimg.cn/large/006AWYXBly1fvvb8k44kjj30rf0j2wke.jpg" alt="" /></p>

<h3 id="loadable-kernel-modules-lkms">Loadable Kernel Modules(LKMs)</h3>

<p>可加载核心模块 (或直接称为内核模块) 就像运行在内核空间的可执行程序，包括:</p>

<ul>
<li>驱动程序（Device drivers）</li>
<li>文件系统驱动</li>
</ul>

<p>LKMs 的文件格式和用户态的可执行程序相同，Linux 下为 ELF，Windows 下为 exe/dll，mac 下为 MACH-O，因此我们可以用 IDA 等工具来分析内核模块。</p>

<h4 id="常用指令">常用指令</h4>

<ul>
<li>insmod: 讲指定模块加载到内核中</li>
<li>rmmod: 从内核中卸载指定模块</li>
<li>lsmod: 列出已经加载的模块</li>
</ul>

<blockquote>
<p>大多数　kernel vulnerability 也出在 LVM 中。</p>
</blockquote>

<h3 id="syscall">syscall</h3>

<p>系统调用，指的是用户空间的程序向操作系统内核请求需要更高权限的服务，比如 IO 操作或者进程间通信。系统调用提供用户程序与操作系统间的接口，部分库函数（如 scanf，puts 等 IO 相关的函数实际上是对系统调用的封装 （read 和 write)）。</p>

<blockquote>
<p>在 <em>/usr/include/x86_64-linux-gnu/asm/unistd_64.h</em> 和 <em>/usr/include/x86_64-linux-gnu/asm/unistd_32.h</em> 分别可以查看 64 位和 32 位的系统调用号。</p>

<p>同时推荐一个很好用的网站 <a href="https://syscalls.kernelgrok.com">Linux Syscall Reference</a>，可以查阅 32 位系统调用对应的寄存器含义以及源码。欢迎师傅们推荐 64 位类似功能的网站。</p>
</blockquote>

<h3 id="状态切换">状态切换</h3>

<h4 id="user-space-to-kernel-space">user space to kernel space</h4>

<p>当发生 <code>系统调用</code>，<code>产生异常</code>，<code>外设产生中断</code>等事件时，会发生用户态到内核态的切换，具体的过程为：</p>

<ol>
<li>通过 <code>swapgs</code> 切换 GS 段寄存器，将 GS 寄存器值和一个特定位置的值进行交换，目的是保存 GS 值，同时将该位置的值作为内核执行时的 GS 值使用。</li>
<li>将当前栈顶（用户空间栈顶）记录在 CPU 独占变量区域里，将 CPU 独占区域里记录的内核栈顶放入 rsp/esp。</li>

<li><p>通过 push 保存各寄存器值，具体的 <a href="http://elixir.free-electrons.com/linux/v4.12/source/arch/x86/entry/entry_64.S">代码</a> 如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"> <span class="nf">ENTRY</span><span class="p">(</span><span class="no">entry_SYSCALL_64</span><span class="p">)</span>
 <span class="err">/*</span> <span class="nf">SWAPGS_UNSAFE_STACK是一个宏</span><span class="err">，</span><span class="no">x86直接定义为swapgs指令</span> <span class="p">*</span><span class="err">/</span>
 <span class="nf">SWAPGS_UNSAFE_STACK</span>
    
 <span class="err">/*</span> <span class="err">保存栈值，并设置内核栈</span> <span class="err">*/</span>
 <span class="nf">movq</span> <span class="nv">%rsp</span><span class="p">,</span> <span class="no">PER_CPU_VAR</span><span class="p">(</span><span class="no">rsp_scratch</span><span class="p">)</span>
 <span class="nf">movq</span> <span class="no">PER_CPU_VAR</span><span class="p">(</span><span class="no">cpu_current_top_of_stack</span><span class="p">),</span> <span class="nv">%rsp</span>
    
    
<span class="err">/*</span> <span class="err">通过</span><span class="nf">push保存寄存器值</span><span class="err">，形成一个</span><span class="no">pt_regs结构</span> <span class="p">*</span><span class="err">/</span>
<span class="err">/*</span> <span class="nf">Construct</span> <span class="no">struct</span> <span class="no">pt_regs</span> <span class="no">on</span> <span class="no">stack</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="no">$__USER_DS</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">ss</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="no">PER_CPU_VAR</span><span class="p">(</span><span class="no">rsp_scratch</span><span class="p">)</span>  <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">sp</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%r11</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">flags</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="no">$__USER_CS</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">cs</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rcx</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">ip</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rax</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">orig_ax</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rdi</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">di</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rsi</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">si</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rdx</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">dx</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%rcx</span> <span class="no">tuichu</span>    <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">cx</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="no">$-ENOSYS</span>        <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">ax</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%r8</span>              <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">r8</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%r9</span>              <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">r9</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%r10</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">r10</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">pushq</span>  <span class="nv">%r11</span>             <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">r11</span> <span class="p">*</span><span class="err">/</span>
<span class="nf">sub</span> <span class="no">$</span><span class="p">(</span><span class="mi">6</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="nv">%rsp</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pt_regs-</span><span class="err">&gt;</span><span class="no">bp</span><span class="p">,</span> <span class="no">bx</span><span class="p">,</span> <span class="no">r12-15</span> <span class="no">not</span> <span class="no">saved</span> <span class="p">*</span><span class="err">/</span></code></pre></td></tr></table>
</div>
</div></li>

<li><p>通过汇编指令判断是否为 x32_abi。</p></li>

<li><p>通过系统调用号，跳到全局变量 <code>sys_call_table</code> 相应位置继续执行系统调用。</p></li>
</ol>

<h4 id="kernel-space-to-user-space">kernel space to user space</h4>

<p>退出时，流程如下：</p>

<ol>
<li>通过 <code>swapgs</code> 恢复 GS 值</li>
<li>通过 <code>sysretq</code> 或者 <code>iretq</code> 恢复到用户控件继续执行。如果使用 <code>iretq</code> 还需要给出用户空间的一些信息（CS, eflags/rflags, esp/rsp 等）</li>
</ol>

<h3 id="mitigation">Mitigation</h3>

<blockquote>
<p>canary, dep, PIE, RELRO 等保护与用户态原理和作用相同</p>
</blockquote>

<ul>
<li>smep:</li>
</ul>

<h3 id="ctf-kernel-pwn-相关">CTF kernel pwn 相关</h3>

<p>一般会给以下三种文件</p>

<ol>
<li>boot.sh: 一个用于启动 kernel 的 shell 的脚本，多用 qemu，保护措施与 qemu 不同的启动参数有关</li>
<li>bzImage: kernel binary</li>
<li>rootfs.cpio: 文件系统映像</li>
</ol>

<p>比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> ls
babydriver.tar
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> x babydriver.tar
boot.sh
bzImage
rootfs.cpio
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> ls
babydriver.tar  boot.sh  bzImage  rootfs.cpio
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> file bzImage
bzImage: Linux kernel x86 boot executable bzImage, version <span class="m">4</span>.4.72 <span class="o">(</span>atum@ubuntu<span class="o">)</span> <span class="c1">#1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0x6, Normal VGA
</span><span class="c1"></span>CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> file rootfs.cpio
rootfs.cpio: gzip compressed data, last modified: Tue Jul  <span class="m">4</span> <span class="m">08</span>:39:15 <span class="m">2017</span>, max compression, from Unix, original size <span class="m">2844672</span>
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> file boot.sh
boot.sh: Bourne-Again shell script, ASCII text executable
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> bat boot.sh 
───────┬─────────────────────────────────────────────────────────────────────────────────
       │ File: boot.sh
───────┼─────────────────────────────────────────────────────────────────────────────────
   <span class="m">1</span>   │ <span class="cp">#!/bin/bash
</span><span class="cp"></span>   <span class="m">2</span>   │ 
   <span class="m">3</span>   │ qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append <span class="s1">&#39;console=ttyS0 ro
</span><span class="s1">       │ ot=/dev/ram oops=panic panic=1&#39;</span> -enable-kvm -monitor /dev/null -m 64M --nographi
       │ c  -smp <span class="nv">cores</span><span class="o">=</span><span class="m">1</span>,threads<span class="o">=</span><span class="m">1</span> -cpu kvm64,+smep
───────┴─────────────────────────────────────────────────────────────────────────────────</code></pre></td></tr></table>
</div>
</div>
<p>解释一下 qemu 启动的参数：</p>

<ul>
<li>-initrd rootfs.cpio，使用 rootfs.cpio 作为内核启动的文件系统</li>
<li>-kernel bzImage，使用 bzImage 作为 kernel 映像</li>
<li>-cpu kvm64,+smep，设置 CPU 的安全选项，这里开启了 smep</li>
<li>-m 64M，设置虚拟 RAM 为 64M，默认为 128M</li>
</ul>

<p>其他的选项可以通过 &ndash;help 查看。</p>

<h2 id="example">Example</h2>

<p>背景知识还有很多，会在分析例题的过程中逐步介绍。</p>

<h3 id="kernel-uaf">kernel UAF</h3>

<p><a href="https://github.com/bash-c/pwn_repo/blob/master/CISCN2017_babydriver/babydriver.tar">attachment here</a></p>

<p>先解压 rootfs.cpio 看一下有什么文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> mkdir core
CISCN2017_babydriver <span class="o">[</span>master●<span class="o">]</span> <span class="nb">cd</span> core 
core <span class="o">[</span>master●<span class="o">]</span> mv ../rootfs.cpio rootfs.cpio.gz
core <span class="o">[</span>master●●<span class="o">]</span> gunzip ./rootfs.cpio.gz 
core <span class="o">[</span>master●<span class="o">]</span> ls
rootfs.cpio
core <span class="o">[</span>master●<span class="o">]</span> cpio -idmv &lt; rootfs.cpio 
.
etc
etc/init.d
etc/passwd
etc/group
...
...
usr/sbin/rdev
usr/sbin/ether-wake
tmp
linuxrc
home
home/ctf
<span class="m">5556</span> 块
core <span class="o">[</span>master●<span class="o">]</span> ls
bin  etc  home  init  lib  linuxrc  proc  rootfs.cpio  sbin  sys  tmp  usr
core <span class="o">[</span>master●<span class="o">]</span> bat init
───────┬─────────────────────────────────────────────────────────────────────────────────
       │ File: init
───────┼─────────────────────────────────────────────────────────────────────────────────
   <span class="m">1</span>   │ <span class="cp">#!/bin/sh
</span><span class="cp"></span>   <span class="m">2</span>   │
   <span class="m">3</span>   │ mount -t proc none /proc
   <span class="m">4</span>   │ mount -t sysfs none /sys
   <span class="m">5</span>   │ mount -t devtmpfs devtmpfs /dev
   <span class="m">6</span>   │ chown root:root flag
   <span class="m">7</span>   │ chmod <span class="m">400</span> flag
   <span class="m">8</span>   │ <span class="nb">exec</span> <span class="m">0</span>&lt;/dev/console
   <span class="m">9</span>   │ <span class="nb">exec</span> <span class="m">1</span>&gt;/dev/console
  <span class="m">10</span>   │ <span class="nb">exec</span> <span class="m">2</span>&gt;/dev/console
  <span class="m">11</span>   │
  <span class="m">12</span>   │ insmod /lib/modules/4.4.72/babydriver.ko
  <span class="m">13</span>   │ chmod <span class="m">777</span> /dev/babydev
  <span class="m">14</span>   │ <span class="nb">echo</span> -e <span class="s2">&#34;\nBoot took </span><span class="k">$(</span>cut -d<span class="s1">&#39; &#39;</span> -f1 /proc/uptime<span class="k">)</span><span class="s2"> seconds\n&#34;</span>
  <span class="m">15</span>   │ setsid cttyhack setuidgid <span class="m">1000</span> sh
  <span class="m">16</span>   │
  <span class="m">17</span>   │ umount /proc
  <span class="m">18</span>   │ umount /sys
  <span class="m">19</span>   │ poweroff -d <span class="m">0</span>  -f
  <span class="m">20</span>   │
───────┴────────────────────────────────────────────────────────────</code></pre></td></tr></table>
</div>
</div>
<h2 id="reference-and-thanks-to">Reference and Thanks to</h2>

<p><a href="https://zh.wikipedia.org/wiki/内核">https://zh.wikipedia.org/wiki/内核</a></p>

<p><a href="https://zh.wikipedia.org/wiki/分级保护域">https://zh.wikipedia.org/wiki/分级保护域</a></p>

<p><a href="https://www.anquanke.com/post/id/86490">https://www.anquanke.com/post/id/86490</a></p>
    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bash-c.github.io/tags/kernel/">kernel</a>
          <a href="https://bash-c.github.io/tags/pwn/">pwn</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/cve-2017-11543-analysis/">
            <span class="next-text nav-default">CVE-2017-11543 Analysis (draft)</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "bash-c/bash-c.github.io"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:I_am_M4x@protonmail.com" rel="me noopener" class="iconfont icon-email"
        title="email">
      </a>
      <a href="http://github.com/bash-c" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://bash-c.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        M4x
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>
  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>








</body>
</html>
